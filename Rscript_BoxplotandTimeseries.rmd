```{r}
library(ggplot2)
library(lubridate)
library(scales)
library(quantmod) # last()
library(reshape)
library(gridExtra)
library(e1071)
library(tseries)
library(forecast)
successiveCabinets<-list()
username<-Sys.info()['user']
SD<-Sys.Date()
windowsFonts(Meiryo=windowsFont("Meiryo"))
fun.readData<-function(){
  dataset<-read.table("clipboard",header=TRUE,sep="\t",stringsAsFactor=F,na.strings=c("-","－"))
  dataset[,1]<-as.Date(dataset[,1])
  monthly<<-2 #日次
  if(unique(day(dataset[,1]))==1){#月次データの日付は月中に変更
    dataset[,1]<-as.Date(paste(year(dataset[,1]),"-",month(dataset[,1]),"-",floor(days_in_month(dataset[,1])/2),sep=""))
    monthly<<-1 #月次
  }
  if(regexpr("JGB.10year",colnames(dataset)[2])!=-1){
    tmpColname<-gsub("JGB.10year","10年物日本国債金利",colnames(dataset)[2])
    tmpColname<-gsub("mean","月中算術平均値",tmpColname)
    tmpColname<-gsub("median","月中中央値",tmpColname)
    tmpColname<-gsub("max","月中最大値",tmpColname)
    tmpColname<-gsub("min","月中最小値",tmpColname)
    colnames(dataset)[2]<-tmpColname
    dataSource<<-"\nデータ出所:財務省"# Federal Reserve Bank of St. Louis
    forcedlevel.type<<-1#レベル系列のチャートタイプ　0:as is , 1:line , 2:bar
  }
  print(head(dataset),3)
  print(tail(dataset),3)
  dataset<<-dataset # caution
}
funMaintitle<-function(){
  mainTitle<-colnames(tmp.dataset)[2]
  mainTitle<-gsub("\\.\\.","\\.",mainTitle)
  mainTitle<-gsub("前年同月比","前年同月比(%)",mainTitle)
  mainTitle<-gsub("割合","割合(%)",mainTitle)
  mainTitle<-gsub("break","\n",mainTitle)
  mainTitle<-gsub("パーセント","%",mainTitle)
  mainTitle<-gsub("mean","月中算術平均値",mainTitle)
  mainTitle<-gsub("median","月中中央値",mainTitle)
  mainTitle<-gsub("max","月中最大値",mainTitle)
  mainTitle<-gsub("min","月中最小値",mainTitle)
  mainTitle<-gsub("失業率","失業率(%)",mainTitle)
  mainTitle<-gsub("過不足率","過不足率(%)",mainTitle)
  mainTitle<-gsub("percent","%",mainTitle)
  mainTitle<-gsub("平均利回り","平均利回り(%)",mainTitle)
  mainTitle<<-mainTitle
}
```

```{r}
################################################### JGB part ###################################################
url<-c(
 "http://www.mof.go.jp/english/jgbs/reference/interest_rate/historical/jgbcme_all.csv",
 "http://www.mof.go.jp/english/jgbs/reference/interest_rate/jgbcme.csv"
)
oldData<-read.csv(url[1],header=T,skip=0,stringsAsFactor=F)
newData<-read.csv(url[2],header=T,skip=1,stringsAsFactor=F)
colnames(oldData)
colnames(newData)
colnames(newData)<-gsub("Y","",colnames(newData))
tmp01<-rbind(oldData,newData)
tmp01[,1]<-as.Date(tmp01[,1])
FUN.1<-function(x) as.numeric(x)
tmp01<-data.frame(tmp01[1],apply(tmp01[-1],2,FUN.1))
colnames(tmp01)[2:length(tmp01)]<-paste("JGB.",gsub("X","",colnames(tmp01)[2:length(tmp01)]),"year",sep="")
colnames(tmp01)[1]<-"Date"
tmp01<-tmp01[,c(1,11)]#10年物のみを抽出
head(tmp01)
tail(tmp01)
################################################### JGB part ###################################################
################################################ from FRED part ################################################
ts.source<-list()
ts.source[[1]]<-c("FRED",1,"DGS10")
for(lll in 1:length(ts.source)){
  if(2<length(ts.source[[lll]])){
    for(iii in 3:length(ts.source[[lll]])){
      item<- ts.source[[lll]][iii]
      tmp02<-getSymbols(item,src=ts.source[[lll]][1],auto.assign=FALSE)
      tmp02<-tmp02[,as.double(ts.source[[lll]][2])]
      tmp02<-data.frame(date=index(tmp02),tmp02, row.names=NULL)
      colnames(tmp02)[1]<-"Date"
      head(tmp02)
      tail(tmp02)
    }
  }
}
################################################ from FRED part ################################################
dataset<-merge(tmp01,tmp02,all=T)
dataset[,4]<-dataset[,3]-dataset[,2]
colnames(dataset)[4]<-"10year.InterestSpread"
head(dataset)
tail(dataset)
pathOutput<-paste("C:/Users/",username,"/Desktop/charts/",sep="")
setwd(pathOutput)
csvFile<-paste("日米国債金利及び金利差",".csv",sep="")
write.csv(dataset,csvFile,row.names=F,append=F,quote=F,fileEncoding="UTF-8")
```

```{r}
#pattern 毎月勤労統計調査
dataset<-read.table("clipboard",header=TRUE,sep="\t",stringsAsFactor=F,na.strings=c("-","－"))
colName<-"実質賃金指数前年同月比-現金給与支給額-5人以上-就業形態計-調査産業計"
tmpSave<-dataset
start<-as.numeric(gsub("年","",dataset[1,1]))
tmp.value<-as.numeric(gsub("\\*","",na.omit(as.vector(t(dataset[,-1])))))
tmp.date<-seq(as.Date(paste(start,"/1/1",sep="")),by="month",length.out=length(tmp.value))
dataset<-data.frame(Date=tmp.date,value=tmp.value)
colnames(dataset)[2]<-colName
monthly<-1 #月次
commonTitle<-""
dataSource<-"\nデータ出所:厚生労働省"
forcedlevel.type<-2#レベル系列のチャートタイプ　0:as is , 1:line , 2:bar
tail(dataset,12)
```

```{r}
commonTitle<-""
dataSource<-"\nデータ出所:The U.S. Census Bureau"# Federal Reserve Bank of St. Louis 株式会社東京商工リサーチ The U.S. Census Bureau
forcedlevel.type<-0#レベル系列のチャートタイプ　0:as is , 1:line , 2:bar
fun.readData()
```

```{r}
tttS<-3
tttE<-3
menulength<-5
orderColumn<-0
orderDirection<-"desc" #asc desc
columnWidth<-"{\"width\":\"10%\",\"targets\":0}"
pathOutput<-paste("C:/Users/",username,"/Desktop/R_Data_Write/",sep="")
setwd(pathOutput)
switch(monthly,
  dateFormat<-"%Y/%m",
  dateFormat<-"%Y/%m/%d"
)
funSuccessiveCabinets()
for(ccc in 2:ncol(dataset)){
  invisible(replicate(20, gc()))
  tmp.dataset<-na.omit(dataset[,c(1,ccc)])  
  funBase()
  funMaintitle()
  funTimeseries()  
  funBoxplot()
  funARIMA()
  funARFIMA()
}  
```

```{r}
#arfima
funARFIMA<-function(){
#ARFIMA
#forecast  
objData<-tmp.dataset[,2] 
arfimaResult<-arfima(
  x=objData,
  drange=c(0,1),
  estim="mle", #"mle","ls"
  lambda=NULL
)  
forecastResult<-forecast(arfimaResult,level=c(0.95),h=12)
arfimaTable01<-data.frame(
  Date=tmp.dataset[,1],
  Original=tmp.dataset[,2],
  FittedByARFIMA=forecastResult$fitted,
  Residual=forecastResult$residuals
)  
setwd(pathOutput)
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste("arfima_",addVer,".png",sep="")
png(file=png.file,width=1600,height=1000)
par(ps=20,mar=c(5,10,5,5),cex.main=1.5,cex.lab=1.5,cex.axis=1.5,family="Meiryo") 
plot(
  arfimaTable01[,1],
  arfimaTable01[,2],
  type="l",
#  main=title,
  family="Meiryo",
  xlab="",
  ylab="",
  ylim=c(min(arfimaTable01[,2:3]),max(arfimaTable01[,2:3])),
  panel.first=grid(nx=NULL,ny=NULL,lty=2,equilogs=T),
  xaxt="n"
)
lines(arfimaTable01[,1],arfimaTable01[,3],type="l",col="blue",lwd=2)
axis.Date(side=1,at=arfimaTable01[,1],format="%Y/%m",padj=1)
labels<-c(colnames(tmp.dataset)[2],paste(colnames(arfimaTable01)[3],forecastResult$method))
cols<-c("black", "blue")
ltys<-c(1, 1)
lwds<-c(1,2)
legend("topleft",legend=labels,col=cols,lty=ltys,lwd=lwds)
dev.off()
coefPhi<-forecastResult$model$ar  
coefDelta<-forecastResult$model$d 
coeftheta<-forecastResult$model$ma  
p<-length(coefPhi)  
d<-length(coefDelta)  
q<-length(coeftheta)  
coefList<-"\n"
if(p!=0){
  coefList<-paste(coefList,paste("p=",p,"(",paste(coefPhi,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"p=",p,"<br>")
}  
if(d!=0){
  coefList<-paste(coefList,paste("d=",d,"(",paste(coefDelta,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"d=",d,"<br>")
}  
if(q!=0){
  coefList<-paste(coefList,paste("q=",q,"(",paste(coeftheta,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"q=",q,"<br>")
}  
equation<-paste(
"<hr><b>Equation</b><br>",  
"ARFIMA(p,d,q)<br>",
"$latex \\Delta^{d}y_{t}=c+\\phi_{1}\\Delta^{d}y_{t-1}+\\cdots\\phi_{p}\\Delta^{d}y_{t-p}+u_{t}+\\theta_{1}u_{t-1}+\\cdots+\\theta_{q}u_{t-q}&s=1$<br>",
coefList,
sep="")
cat(equation,file=htmlFile,append=T) 
cat(paste("<a href=\"http://archive.am-consulting.co.jp/",png.file,
  "\"><img src=\"http://archive.am-consulting.co.jp/",png.file,
  "\" alt=\"",png.file,"\" width=\"100%\"></a>",sep=""),file=htmlFile,append=T) 
#arfima
}
#```

#```{r}
#arima
funARIMA<-function(){
#ARIMA
#forecast
objData<-tmp.dataset[,2]
arimaResult<-auto.arima(
  x=objData,
  d=NA,
  D=NA,
  max.p=5,
  max.q=5,
  max.P=2,
  max.Q=2,
  max.order=5,
  max.d=2,
  max.D=1,
  start.p=2,
  start.q=2,
  start.P=1,
  start.Q=1,
  stationary=F,
  seasonal=T,
  ic="aic", #"aicc","aic","bic"
  stepwise=T,
  trace=F,
  approximation=(length(objData)>100 | frequency(objData)>12),
  xreg=NULL,
  test="kpss", #"kpss","adf","pp"
  seasonal.test="ocsb", #"ocsb","ch"
  allowdrift=T,
  lambda=NULL,
  parallel=F,
  num.cores=2
)
forecastResult<-forecast(
  object=arimaResult,
  h=12,
  level=c(0.95),
  fan=F,
  robust=F,
  lambda=NULL,
  find.frequency=F
)
arimaTable01<-data.frame(
  Date=tmp.dataset[,1],
  Original=tmp.dataset[,2],
  FittedByARIMA=forecastResult$fitted,
  Residual=forecastResult$residuals
)
setwd(pathOutput)
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste("arima_",addVer,".png",sep="")
png(file=png.file,width=1600,height=1000)
par(ps=20,mar=c(5,10,5,5),cex.main=1.5,cex.lab=1.5,cex.axis=1.5,family="Meiryo") 
plot(
  arimaTable01[,1],
  arimaTable01[,2],
  type="l",
#  main=title,
  family="Meiryo",
  xlab="",
  ylab="",
  ylim=c(min(arimaTable01[,2:3]),max(arimaTable01[,2:3])),
  panel.first=grid(nx=NULL,ny=NULL,lty=2,equilogs=T),
  xaxt="n"
)
lines(arimaTable01[,1],arimaTable01[,3],type="l",col="blue",lwd=2)
axis.Date(side=1,at=arimaTable01[,1],format="%Y/%m",padj=1)
labels<-c(colnames(tmp.dataset)[2],paste(colnames(arimaTable01)[3],forecastResult$method))
cols<-c("black", "blue")
ltys<-c(1, 1)
lwds<-c(1,2)
legend("topleft",legend=labels,col=cols,lty=ltys,lwd=lwds)
dev.off()
coefPhi<-arimaResult$model$phi  
coefDelta<-arimaResult$model$Delta  
coeftheta<-arimaResult$model$theta  
p<-length(coefPhi)  
d<-length(coefDelta)  
q<-length(coeftheta)  
coefList<-"\n"
if(p!=0){
  coefList<-paste(coefList,paste("p=",p,"(",paste(coefPhi,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"p=",p,"<br>")
}  
if(d!=0){
  coefList<-paste(coefList,paste("d=",d,"(",paste(coefDelta,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"d=",d,"<br>")
}  
if(q!=0){
  coefList<-paste(coefList,paste("q=",q,"(",paste(coeftheta,collapse=","),")",seP=""),"<br>")
}else{
  coefList<-paste(coefList,"q=",q,"<br>")
}  
equation<-paste(
"<hr><b>Equation</b><br>",  
"ARIMA(p,d,q)<br>",
"$latex \\Delta^{d}y_{t}=c+\\phi_{1}\\Delta^{d}y_{t-1}+\\cdots\\phi_{p}\\Delta^{d}y_{t-p}+u_{t}+\\theta_{1}u_{t-1}+\\cdots+\\theta_{q}u_{t-q}&s=1$<br>",
coefList,
sep="")
cat(equation,file=htmlFile,append=T) 
cat(paste("<a href=\"http://archive.am-consulting.co.jp/",png.file,
  "\"><img src=\"http://archive.am-consulting.co.jp/",png.file,
  "\" alt=\"",png.file,"\" width=\"100%\"></a>",sep=""),file=htmlFile,append=T) 
}
#arima
#```

#```{r}
funSuccessiveCabinets<-function(){
successiveCabinets[[1]]<-c(
"1937-6-4","近衛文麿",
"1939-1-5","平沼騏一郎",
"1939-8-30","阿部信行",
"1940-1-16","米内光政",
"1940-7-22","近衛文麿(2次)",
"1941-10-18","東條英機",
"1944-7-22","小磯國昭",
"1945-4-7","鈴木貫太郎",
"1945-8-17","東久邇宮稔彦王",
"1945-10-9","幣原喜重郎",
"1946-5-22","吉田茂",
"1947-5-24","片山哲",
"1948-3-10","芦田均",
"1948-10-15","吉田茂(2-5次)",
"1954-12-10","鳩山一郎",
"1956-12-23","石橋湛山",
"1957-2-25","岸信介",
"1960-7-19","池田勇人",
"1964-11-9","佐藤栄作",
"1972-7-7","田中角栄",
"1974-12-9","三木武夫",
"1976-12-24","福田赳夫",
"1978-12-7","大平正芳",
"1980-7-17","鈴木善幸",
"1982-11-27","中曽根康弘",
"1987-11-6","竹下登",
"1989-6-3","宇野宗佑",
"1989-8-10","海部俊樹",
"1991-11-5","宮沢喜一",
"1993-8-9","細川護熙",
"1994-4-28","羽田孜",
"1994-6-30","村山富市",
"1996-1-11","橋本龍太郎",
"1998-7-30","小渕恵三",
"2000-4-5","森喜朗",
"2001-4-26","小泉純一郎",
"2006-9-26","安倍晋三",
"2007-9-26","福田康夫",
"2008-9-24","麻生太郎",
"2009-9-16","鳩山由紀夫",
"2010-6-8","菅直人",
"2011-9-2","野田佳彦",
"2012-12-26","安倍晋三(2次-)"
)
successiveCabinets[[2]]<-c(
"1937-7-27","結城豊太郎",
"1944-3-18","渋沢敬三",
"1945-10-9","新木榮吉",
"1946-6-1","一万田尚登",
"1954-12-11","新木榮吉(2次)",
"1956-11-30","山際正道",
"1964-12-17","宇佐美洵",
"1969-12-17","佐々木直",
"1974-12-17","森永貞一郎",
"1979-12-17","前川春雄",
"1984-12-17","澄田智",
"1989-12-17","三重野康",
"1994-12-17","松下康雄",
"1998-3-20","速水優",
"2003-3-20","福井俊彦",
"2008-4-9","白川方明",
"2013-3-20","黒田東彦"
)
successiveCabinets[[3]]<-c(
"1933-3-4","Franklin Delano Roosevelt",  
"1945-4-12","Harry S. Truman",
"1953-1-20","Dwight David Eisenhower",
"1961-1-20","John Fitzgerald Kennedy",
"1963-11-22","Lyndon Baines Johnson",
"1969-1-20","Richard Milhouse Nixon",
"1974-8-9","Gerald Rudolph Ford Jr.",
"1977-1-20","James Earl Carter",
"1981-1-20","Ronald Wilson Reagan",
"1989-1-20","George H.W Bush",
"1993-1-20","Bill Clinton",
"2001-1-20","George W. Bush",
"2009-1-20","Barack Obama"
)
successiveCabinets[[4]]<-c(
"1934-11-15","Marriner Eccles",
"1948-4-15","Thomas B. McCabe",
"1951-4-2","William M. Martin",
"1970-2-1","Arthur F.Burns",
"1978-3-8","G.William Miller",
"1987-8-11","Alan Greenspan",
"2006-2-1","Ben S.Bernanke",
"2014-2-1","Janet Yellen"
)
for(ttt in 1:length(successiveCabinets)){
  tmp<-successiveCabinets[[ttt]]
  inaugural.date<-as.Date(tmp[seq(1,length(tmp),by=2)])
  resignation.date<-c((inaugural.date-1)[-1],Sys.Date()+31) # 最後のSys.Date()+31は現職用
  Name<-tmp[seq(2,length(tmp),by=2)]
  successiveCabinets[[ttt]]<-data.frame(inaugural.date,resignation.date,Name)
  successiveCabinets[[ttt]][,3]<-ordered(successiveCabinets[[ttt]][,3],levels=successiveCabinets[[ttt]][,3][1:nrow(successiveCabinets[[ttt]])])
  order(successiveCabinets[[ttt]][,3])
  successiveCabinets[[ttt]]<<-successiveCabinets[[ttt]] #caution
}
}  
######################################時系列チャート###################################### 
funTimeseries<-function(){
setwd(pathOutput)
first.date<-c("1937-6-4","1937-7-27","1949-1-20","1970-2-1")
for(ttt in tttS:tttE){ #ttt 1:首相 2:日銀総裁
  ST<-Sys.time()  
  addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
  png.file<-paste("ts_",ccc,"_",ttt,"_",addVer,".png",sep="")
  png(file=png.file,width=1600,height=1000)
  tmp.timeseries<-tmp.dataset
  tmp.date<-max(as.Date(first.date[ttt]),na.omit(tmp.timeseries)[1,1])
  tmp.timeseries<-na.omit(subset(tmp.timeseries,tmp.date<=tmp.timeseries[,1]))
  colnames(tmp.timeseries)[2]<-"value"
  for(kkk in seq(1,nrow(successiveCabinets[[ttt]]),by=1)){
    if(successiveCabinets[[ttt]][kkk,1]<=tmp.date & tmp.date<=successiveCabinets[[ttt]][kkk,2]){break}  
  }
  tmp.segment<-successiveCabinets[[ttt]][c(kkk:nrow(successiveCabinets[[ttt]])),]
  tmp.segment[1,1]<-tmp.date
  tmp.segment[nrow(tmp.segment),2]<-last(tmp.timeseries)[1]
  x0<-tmp.segment$inaugural.date[seq(1,length(tmp.segment$inaugural.date),by=2)]
  x1<-tmp.segment$resignation.date[seq(1,length(tmp.segment$resignation.date),by=2)]
  y0<-min(tmp.timeseries[,2])
  if(length((tmp.timeseries$value)[tmp.timeseries$value<0])!=0 & length((tmp.timeseries$value)[0<tmp.timeseries$value])!=0){
    level.type<-2 #データがプラス値とマイナス値からなる場合はバーチャートとする
  }else{
    level.type<-1 #データがプラス値のみ又はマイナス値のみの場合はラインチャートとする
  }
  if(forcedlevel.type!=0){level.type<-forcedlevel.type}
  if(0<y0 & level.type==2){y0<-0}
  y1<-max(tmp.timeseries[,2])
  shade<-data.frame(x0,x1,y0,y1)
  value.y<-(max(tmp.timeseries[,2])+min(tmp.timeseries[,2]))/2 #median(tmp.timeseries[,2]) #value.y<-mean(tmp.timeseries[,2])
  value.y<<-value.y #caution
  level.type<<-level.type #caution
  g<-ggplot()
  g<-g+geom_rect(data=shade,aes(xmin=x0,xmax=x1,ymin=y0,ymax=y1),fill='gray80',alpha=0.5)
  g<-g+geom_segment(data=tmp.segment,aes(x=inaugural.date,xend=resignation.date,y=value.y,yend=value.y,colour=Name),size=8)
  if(level.type==1){
    g<-g+geom_line(data=tmp.timeseries,aes(x=Date,y=value),size=2)
  }else{
    g<-g+geom_bar(data=tmp.timeseries,aes(x=Date,y=value),stat="identity",position="identity",fill="blue",alpha=0.5)#,color="black"
  } 
  g<-g+geom_smooth(data=tmp.timeseries,aes(x=Date,y=value),method=lm)
  g<-g+geom_smooth(data=tmp.timeseries,aes(x=Date,y=value),method=loess,color="red")
  g<-g+ggtitle(paste(commonTitle,mainTitle,dataSource))
  g<-g+xlab("") 
  g<-g+ylab("") 
  g<-g+theme(axis.text=element_text(size=30,face="plain",family="Meiryo"))          
  g<-g+theme(axis.title=element_text(size=30,face="plain",family="Meiryo"))          
  g<-g+theme(title=element_text(size=30,face="plain",family="Meiryo"))          
  g<-g+theme(legend.position="right")          
  g<-g+theme(legend.text=element_text(colour="black",size=30,face="plain",family="Meiryo"))          
  g<-g+theme(legend.title=element_text(colour="white",size=0,face="plain")) 
#  g<-g+annotate("text",x=tmp.timeseries[1,1],y=y1+(y1-y0)/5,label=plotText,size=10,family="Meiryo",hjust=0,vjust=0.9,col="black")
  g<-g+scale_x_date(labels=date_format(dateFormat))
#  g<-g+scale_x_date(labels=date_format("%Y-%m"))#当面日付タイプに係らず年-月とする
  g<-g+scale_y_continuous(labels=comma)#,limits=c(y0,(y1-y0)/5+y1))
  print(g)
  dev.off()
if(ttt==1 | ttt==3){
#only html
htmldataset<-tmp.timeseries
if(ttt==1){
  colnames(htmldataset)<-c("Date","Value","内閣総理大臣","日銀総裁")  
}else if(ttt==3){
  colnames(htmldataset)<-c("Date","Value","President","FRB")  
}  
col<-list()
grandData<-NULL
header<-NULL
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
tableID<-paste("am-consulting",addVer,sep="")
htmlFile<-paste(addVer,".html",sep="")
htmlFile<<-htmlFile  
cat("<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js\"></script>",file=htmlFile,append=F)
cat("<link href=\"http://cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css\" rel=\"stylesheet\">",file=htmlFile,append=T)  
cat("<script src=\"http://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js\"></script>\n\n\n\n",file=htmlFile,append=T) 
cat("<script type=\"text/javascript\" charset=\"utf-8\">$(document).ready( function(){\n",file=htmlFile,append=T)
cat(paste("$('#",tableID,"').dataTable( {\n",sep=""),file=htmlFile,append=T)
cat("\"lengthMenu\": [[",menulength,",-1,100,200], [",menulength,",\"All\",100,200]],\n",file=htmlFile,append=T)
cat(paste("\"order\": [[ ",orderColumn,", \"",orderDirection,"\" ]],\n",sep=""),file=htmlFile,append=T)
cat("\"searching\": true,\n",file=htmlFile,append=T)
cat("\"columnDefs\":[",columnWidth,"],\n",file=htmlFile,append=T)
cat("\"language\": {\"decimal\": \".\",\"thousands\": \",\"}\n\n",file=htmlFile,append=T)
#cat("});",file=htmlFile,append=T)
#Individual column searching part  
cat(",initComplete: function () {\n",file=htmlFile,append=T)
cat("this.api().columns().every( function () {\n",file=htmlFile,append=T)
cat("var column = this;\n",file=htmlFile,append=T)
cat("var select = $('<select><option value=\"\"></option></select>')\n",file=htmlFile,append=T)
cat(".appendTo( $(column.footer()).empty() )\n",file=htmlFile,append=T)
cat(".on( 'change', function () {\n",file=htmlFile,append=T)
cat("var val = $.fn.dataTable.util.escapeRegex(\n",file=htmlFile,append=T)
cat("$(this).val()\n",file=htmlFile,append=T)
cat(");\n",file=htmlFile,append=T)
cat("column\n",file=htmlFile,append=T)
cat(".search( val ? '^'+val+'$' : '', true, false )\n",file=htmlFile,append=T)
cat(".draw();\n",file=htmlFile,append=T)
cat("} );\n",file=htmlFile,append=T)
cat("column.data().unique().sort().each( function ( d, j ) {\n",file=htmlFile,append=T)
cat("select.append( '<option value=\"'+d+'\">'+d+'</option>' )\n",file=htmlFile,append=T)
cat("} );\n",file=htmlFile,append=T)
cat("} );\n",file=htmlFile,append=T)
cat("}\n",file=htmlFile,append=T)
#Individual column searching part  
#Row created callback  
cat(",\"createdRow\": function ( row, data, index ) {\n",file=htmlFile,append=T)
cat("if ( data[1].replace('', '') * 1 < 0 ) {\n",file=htmlFile,append=T)
cat("$('td', row).eq(1).addClass('highlight');\n",file=htmlFile,append=T)
cat("}\n",file=htmlFile,append=T)
cat("}\n",file=htmlFile,append=T)  
#Row created callback  
cat("});\n\n\n\n\n",file=htmlFile,append=T)
#正規表現  
cat(paste("$('#",tableID,"').dataTable();",sep=""),file=htmlFile,append=T)
cat("$('input.global_filter').on( 'keyup click', function () {",file=htmlFile,append=T)
cat("filterGlobal();",file=htmlFile,append=T)
cat("} );",file=htmlFile,append=T)
cat("$('input.column_filter').on( 'keyup click', function () {",file=htmlFile,append=T)
cat("filterColumn( $(this).parents('tr').attr('data-column') );",file=htmlFile,append=T)
cat("} );  ",file=htmlFile,append=T)
#正規表現  
#calStat part  
cat(paste("$('#",tableID,"')",sep=""),file=htmlFile,append=T)
cat(".on( 'column-sizing.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'column-visibility.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'destroy.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'draw.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'init.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'length.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'order.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'page.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'pre.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'preXhr.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'processing.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'search.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'stateLoaded.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'stateLoadParams.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'stateSaveParams.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".on( 'xhr.dt', function () {calStat()} )",file=htmlFile,append=T)
cat(".dataTable();\n\n\n\n\n",file=htmlFile,append=T)
#calStat part  
cat("});</script>\n\n\n\n\n",file=htmlFile,append=T)
cat("<!--Row created callback--><style>td.highlight {font-weight: plain;color: red;}</style><!--Row created callback-->\n",file=htmlFile,append=T) 
#calStat part  
cat("<script>window.onload = function(){calStat()};</script>",file=htmlFile,append=T)
cat("<script>",file=htmlFile,append=T)
cat("function calStat(){",file=htmlFile,append=T)
cat(paste("var sum = 0 , count = 0 , all = $('#",tableID," > tbody > tr') , variance = 0, countPlus = 0;",sep=""),file=htmlFile,append=T)
cat("all.each(function() {",file=htmlFile,append=T)
cat("sum += +$('td:eq(1)', this).text();",file=htmlFile,append=T)
cat("count++;",file=htmlFile,append=T)
cat("});",file=htmlFile,append=T)
cat("//all.find('td:eq(5)').text((sum / count).toFixed(1));\n",file=htmlFile,append=T)
cat("mean = sum / count;",file=htmlFile,append=T)
cat("all.each(function() {",file=htmlFile,append=T)
cat("tmp = $('td:eq(1)', this).text()-mean;",file=htmlFile,append=T)
cat("variance = variance + tmp*tmp;",file=htmlFile,append=T)
cat("if( 0<= $('td:eq(1)', this).text() ){countPlus++}",file=htmlFile,append=T)
cat("});",file=htmlFile,append=T)
cat("variance = variance / count;",file=htmlFile,append=T)
cat("deviation = Math.pow(variance,0.5);",file=htmlFile,append=T)
cat("document.form1.mean.value = mean.toFixed(2);",file=htmlFile,append=T)
cat("document.form1.variance.value = variance.toFixed(2);",file=htmlFile,append=T)
cat("document.form1.deviation.value = deviation.toFixed(2);",file=htmlFile,append=T)
cat("document.form1.countPlus.value = countPlus.toFixed(2);",file=htmlFile,append=T)
cat("}",file=htmlFile,append=T)
cat("</script>",file=htmlFile,append=T)
#calStat part  
cat("<b>",mainTitle,"</b><br>",file=htmlFile,append=T)
cat(dataSource,"<br>",file=htmlFile,append=T)
cat("最新データは\"数表リスト\"( http://equations.am-consulting.co.jp/?page_id=2074 )から確認ください<br>",file=htmlFile,append=T)
#calStat part  
cat("<form name=\"form1\">",file=htmlFile,append=T)
cat("<table width=\"100%\"><tbody>",file=htmlFile,append=T)
cat("<tr>",file=htmlFile,append=T)
cat("<td style=\"text-align:center\" colspan=\"4\">テーブル表示範囲の基本統計量</td>",file=htmlFile,append=T)
cat("</tr>",file=htmlFile,append=T)
cat("<tr>",file=htmlFile,append=T)
cat("<td style=\"width:25%;text-align:right\" bgcolor=\"#F5F5F5\">平均値</td>",file=htmlFile,append=T)
cat("<td style=\"width:25;\"><input type=\"number\" style=\"ime-mode:disabled;text-align:right\" name=\"mean\" size=\"10\"></td>",file=htmlFile,append=T)
cat("<td style=\"width:25%;text-align:right\" bgcolor=\"#F5F5F5\">標本分散</td>",file=htmlFile,append=T)
cat("<td style=\"width:25%;\"><input type=\"number\" style=\"ime-mode:disabled;text-align:right\" name=\"variance\" size=\"10\"></td>",file=htmlFile,append=T)
cat("</tr>",file=htmlFile,append=T)
cat("<tr>",file=htmlFile,append=T)
cat("<td style=\"text-align:right\" bgcolor=\"#F5F5F5\">標本偏差</td>",file=htmlFile,append=T)
cat("<td><input type=\"number\" style=\"ime-mode:disabled;text-align:right\" name=\"deviation\" size=\"10\"></td>",file=htmlFile,append=T)
cat("<td style=\"text-align:right\" bgcolor=\"#F5F5F5\">プラス値データ数</td>",file=htmlFile,append=T)
cat("<td><input type=\"number\" style=\"ime-mode:disabled;text-align:right\" name=\"countPlus\" size=\"10\"></td>",file=htmlFile,append=T)
cat("</tr>",file=htmlFile,append=T)
cat("</tbody></table>",file=htmlFile,append=T)
cat("</form>",file=htmlFile,append=T)
#Reference http://stackoverflow.com/questions/12212567/jquery-calculate-average-of-column-values-and-put-it-in-each-td-of-another-co  
#calStat part
#正規表現
cat("<b>正規表現対応フィルターボックス</b>",file=htmlFile,append=T)  
cat("\n<table width=\"100%\"><thead><tr><th width=\"15%\" style=\"text-align:center\">Target</th><th width=\"75%\" style=\"text-align:center\">Search text</th><th style=\"text-align:center\">Regex</th></tr></thead><tbody>\n",file=htmlFile,append=T)
for(rccc in 1:ncol(htmldataset)){
cat(paste("<tr id=\"filter_col",rccc,"\" data-column=\"",rccc-1,"\">\n",sep=""),file=htmlFile,append=T)
cat(paste("<td>",colnames(htmldataset)[rccc],"</td>",sep=""),file=htmlFile,append=T)
cat(paste("<td align=\"center\"><input type=\"text\" class=\"column_filter\" id=\"col",rccc-1,"_filter\"  style=\"width:100%\"></td>\n",sep=""),file=htmlFile,append=T)
cat(paste("<td align=\"center\"><input type=\"checkbox\" class=\"column_filter\" id=\"col",rccc-1,"_regex\" checked=\"checked\"></td>\n",sep=""),file=htmlFile,append=T)
#cat(paste("<td align=\"center\"><input type=\"checkbox\" class=\"column_filter\" id=\"col",rccc-1,"_smart\" checked=\"checked\"></td>\n",sep=""),file=htmlFile,append=T)
cat("</tr>\n",file=htmlFile,append=T)
}  
cat("\n</tbody></table>",file=htmlFile,append=T)  
cat("<script>\n",file=htmlFile,append=T)  
cat("function filterGlobal () {\n",file=htmlFile,append=T) 
cat(paste("$('#",tableID,"').DataTable().search(\n",sep=""),file=htmlFile,append=T) 
cat("$('#global_filter').val(),\n",file=htmlFile,append=T) 
cat("$('#global_regex').prop('checked'),\n",file=htmlFile,append=T) 
cat("$('#global_smart').prop('checked')\n",file=htmlFile,append=T) 
cat(").draw();\n",file=htmlFile,append=T) 
cat("}\n",file=htmlFile,append=T) 
cat("function filterColumn ( i ) {\n",file=htmlFile,append=T)
cat(paste("$('#",tableID,"').DataTable().column( i ).search(\n",sep=""),file=htmlFile,append=T)
cat("$('#col'+i+'_filter').val(),\n",file=htmlFile,append=T)
cat("$('#col'+i+'_regex').prop('checked'),\n",file=htmlFile,append=T)
cat("$('#col'+i+'_smart').prop('checked')\n",file=htmlFile,append=T)
cat(").draw();\n",file=htmlFile,append=T)
cat("}\n",file=htmlFile,append=T)
cat("</script>\n",file=htmlFile,append=T)  
#正規表現
for(ccc in 1:ncol(htmldataset)){
  if(ccc==1){
    col[[ccc]]<-paste("<td align=\"right\" valign=\"middle\">",format(as.Date(htmldataset[,ccc]),dateFormat),"</td>",sep="")
  }else{  
    #col[[ccc]]<-paste("<td align=\"right\" valign=\"middle\">",format(htmldataset[,ccc],big.mark=",",scientific=F),"</td>",sep="")
    col[[ccc]]<-paste("<td align=\"right\" valign=\"middle\">",format(htmldataset[,ccc],scientific=F),"</td>",sep="")
  }  
  grandData<-cbind(grandData,col[[ccc]])
  header<-paste(header,"<th>",colnames(htmldataset)[ccc],"</th>",sep="")  
}
tableHtml<-paste("<table cellpadding=\"0\" cellspacing=\"0\" id=\"",tableID,"\" width=\"100%\" class=\"display\"><thead>",sep="")
tableHtml<-paste(tableHtml,header,"</thead><tfoot>",sep="")
tableHtml<-paste(tableHtml,header,"</tfoot>",sep="")
cat(tableHtml,file=htmlFile,append=T)
grandData<-data.frame("<tr>",grandData,"</tr>",row.names=NULL)
write.table(grandData,htmlFile,quote=F,col.names=F, append=T,row.names=F)
cat("</table>",file=htmlFile,append=T)
cat("Powered by DataTables( http://datatables.net/ )",file=htmlFile,append=T)  
x<-tmp.timeseries[,2]  
bvalue<-c(
mean(x),                                        #01 平均値  
median(x),                                      #02 中央値
var(x)*(length(x)-1)/length(x),                 #03 標本不偏分散 
(var(x)*(length(x)-1)/length(x))^0.5,           #04 標本標準偏差 
as.vector(quantile(x,c(0.05,0.1,0.9,0.95))[1]), #05 5%
as.vector(quantile(x,c(0.05,0.1,0.9,0.95))[2]), #06 10%
as.vector(quantile(x,c(0.05,0.1,0.9,0.95))[3]), #07 90%
as.vector(quantile(x,c(0.05,0.1,0.9,0.95))[4]), #08 95%
skewness(x),                                    #09 原系列歪度  
kurtosis(x),                                    #10 原系列尖度  
skewness(diff(x)),                              #11 1次差分歪度  
kurtosis(diff(x)),                              #12 1次差分尖度  
adf.test(x)$p.value,                            #13 原系列単位根検定   
adf.test(diff(x))$p.value,                      #14 1次差分単位根検定
0  
)  
btitle<-c(
"平均値",                #01 平均値  
"中央値",                #02 中央値
"標本不偏分散",          #03 標本不偏分散 
"標本標準偏差",          #04 標本標準偏差 
"5パーセンタイル",       #05 5%
"10パーセンタイル",      #06 10%
"90パーセンタイル",      #07 90%
"95パーセンタイル",      #08 95%
"原系列歪度",            #09 原系列歪度  
"原系列尖度",            #10 原系列尖度  
"1次差分歪度",           #11 1次差分歪度  
"1次差分尖度",           #12 1次差分尖度  
"原系列単位根検定:p値",  #13 原系列単位根検定   
"1次差分単位根検定:p値", #14 1次差分単位根検定
"dammy"  
)
cat(paste(
  "<br><hr><b>対象期間:</b>",
  format(first(tmp.timeseries[,1]),"%Y/%m"),
  "-",
  format(last(tmp.timeseries[,1]),"%Y/%m"),
  "\n",
  sep=""),file=htmlFile,append=T
)  
cat("\n<table width=\"100%\">\n",file=htmlFile,append=T) # cellpadding=\"0\" cellspacing=\"0\"  
for(aaa in seq(1,14,by=2)){
  cat("<tr>\n",file=htmlFile,append=T)
  cat("<td style=\"width:25%;text-align:center;vertical-align:middle;\" bgcolor=\"#F5F5F5\">\n",file=htmlFile,append=T)
  cat(btitle[aaa],"\n",file=htmlFile,append=T)
  cat("</td>\n",file=htmlFile,append=T)
  cat("<td style=\"width:25%;text-align:right;vertical-align:middle;\">\n",file=htmlFile,append=T)
  cat(bvalue[aaa],"\n",file=htmlFile,append=T)
  cat("</td>\n",file=htmlFile,append=T)
  cat("<td style=\"width:25%;text-align:center;vertical-align:middle;\" bgcolor=\"#F5F5F5\">\n",file=htmlFile,append=T)
  cat(btitle[aaa+1],"\n",file=htmlFile,append=T)
  cat("</td>\n",file=htmlFile,append=T)
  cat("<td style=\"width:25%;text-align:right;vertical-align:middle;\">\n",file=htmlFile,append=T)
  cat(bvalue[aaa+1],"\n",file=htmlFile,append=T)
  cat("</td>\n",file=htmlFile,append=T)
  cat("</tr>\n",file=htmlFile,append=T)
}  
cat("</table>",file=htmlFile,append=T)
#only html
}  
cat(paste("<a href=\"http://archive.am-consulting.co.jp/",png.file,
  "\"><img src=\"http://archive.am-consulting.co.jp/",png.file,
  "\" alt=\"",png.file,"\" width=\"100%\"></a>",sep=""),file=htmlFile,append=T)  
}
#以下はデータ確認用にグローバル化する
tmp.segment<<-tmp.segment  
tmp.timeseries<<-tmp.timeseries
shade<<-shade  
}  
######################################時系列チャート###################################### 
###################################### boxplotパート######################################
funBoxplot<-function(){
setwd(pathOutput)
for(ttt in tttS:tttE){    
  ST<-Sys.time()  
  addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
  png.file<-paste("bo_",ccc,"_",ttt,"_",addVer,".png",sep="")
  png(file=png.file,width=1600,height=1000)
  if(ttt<=2){
    tmp.boxplot<-tmp.dataset[,c(2,2+ttt)]
  }else{
    tmp.boxplot<-tmp.dataset[,c(2,ttt)]
  }  
  colnames(tmp.boxplot)[2]<-"Person"  
  tmp.boxplot<-melt(tmp.boxplot,id="Person")
  tmp.boxplot<-tmp.boxplot[,-2]
  tmp.boxplot[,2]<-as.numeric(tmp.boxplot[,2])
  colnames(tmp.boxplot)[1]<-"variable"
  g<-ggplot(data=tmp.boxplot,aes(x=variable,y=value))
  g<-g+geom_boxplot(lwd=2)
  g<-g+ggtitle(paste(commonTitle,mainTitle,dataSource))
  g<-g+theme(axis.text.x=element_text(size=30,angle=90,hjust=1,vjust=0.5,face="plain",family="Meiryo")) 
  g<-g+theme(axis.text.y=element_text(size=30,face="plain",family="Meiryo")) 
  g<-g+theme(axis.title=element_text(size=30,face="plain",family="Meiryo")) 
  g<-g+theme(title=element_text(size=30,face="plain",family="Meiryo")) 
  g<-g+xlab("")
  g<-g+ylab("") 
  g<-g+scale_y_continuous(labels=comma)
  print(g)
  dev.off()
  cat(paste("<a href=\"http://archive.am-consulting.co.jp/",png.file,
    "\"><img src=\"http://archive.am-consulting.co.jp/",png.file,
    "\" alt=\"",png.file,"\" width=\"100%\"></a>",sep=""),file=htmlFile,append=T)  
}
tmp.boxplot<<-tmp.boxplot #確認用にグローバル化する  
}  
###################################### boxplotパート######################################
funBase<-function(){
border.date<-as.Date(max(successiveCabinets[[tttS]][1,1],successiveCabinets[[tttS+1]][1,1]))
tmp.dataset<-subset(tmp.dataset,border.date<=tmp.dataset[,1])
buf<-list()
cnt<-0
for(ttt in tttS:(tttS+1)){ #目的に応じて変更 1:2 or 3:4
  cnt<-cnt+1
  for(nnn in 1:nrow(successiveCabinets[[ttt]])){  
    tmp<-subset(tmp.dataset,successiveCabinets[[ttt]]$inaugural.date[nnn]<=tmp.dataset$Date & tmp.dataset$Date<=successiveCabinets[[ttt]]$resignation.date[nnn])
    if(nnn==1){buf[[cnt]]<-head(tmp,0)} #Error in buf[[cnt]] : subscript out of bounds
    if(nrow(tmp)!=0){
      tmp[,3]<-successiveCabinets[[ttt]]$Name[nnn]
      colnames(tmp)[3]<-ttt
      buf[[cnt]]<-rbind(buf[[cnt]],tmp)    
    }    
  }
}
tmp.dataset<-merge(buf[[1]],buf[[2]],all=T) #PM(USA)とBoJ(FRB)は長さの異なる個別のデータとして流用することが出来る様、最後にmergeする。    
if(ttt==2){colnames(tmp.dataset)[3]<-"PM";colnames(tmp.dataset)[4]<-"BoJ"}
if(ttt==4){colnames(tmp.dataset)[3]<-"U.S.A";colnames(tmp.dataset)[4]<-"FRB"}
tmp.dataset<<-tmp.dataset  
subsetDataset<-subset(tmp.dataset,max(tmp.dataset[,2])==tmp.dataset[,2])  
maxDate<<-paste((format(subsetDataset[,1],dateFormat)),collapse=",")
maxValue<<-max(tmp.dataset[,2])
maxPM<<-paste(subsetDataset[,3],collapse=",")
maxBoJ<<-paste(subsetDataset[,4],collapse=",")
subsetDataset<-subset(tmp.dataset,min(tmp.dataset[,2])==tmp.dataset[,2])  
minDate<<-paste((format(subsetDataset[,1],dateFormat)),collapse=",")
minValue<<-min(tmp.dataset[,2])
minPM<<-paste(subsetDataset[,3],collapse=",")
minBoJ<<-paste(subsetDataset[,4],collapse=",")
latestDate<<-format(as.Date(last(tmp.dataset[,1])),dateFormat)
latestValue<<-last(tmp.dataset[,2])
latestPM<<-last(tmp.dataset[,3])
latestBoJ<<-last(tmp.dataset[,4])
firstDate<<-format(as.Date(first(tmp.dataset[,1])),dateFormat)
underZero<-nrow(subset(tmp.dataset,tmp.dataset[,2]<0))
overZero<-nrow(tmp.dataset)-underZero
Vavg<-mean(tmp.dataset[,2])  
Vmed<-median(tmp.dataset[,2])
Vvar<-var(tmp.dataset[,2])
switch(monthly,
timeDiff<-paste(",Difference:",nrow(tmp.dataset)-1,"months"),  
timeDiff<-paste(",Difference:",(as.Date(latestDate)-as.Date(firstDate)),"days")  
)  
plotText<<-paste(
  "Period:",firstDate,"-",latestDate,timeDiff,
  "\nHighest:",maxDate,",",maxValue,",",maxPM,"&",maxBoJ,
  "\nLowest:",minDate,",",minValue,",",minPM,"&",minBoJ,
  "\nLatest:",latestDate,",",latestValue,",",latestPM,"&",latestBoJ,
  "\nMean:",Vavg,
  "\nMedian:",Vmed,
  "\nVar:",Vvar,
  "\nn(<0):",underZero,
  "\nn(0<=):",overZero,
  "\nRatio(%,<0):",round(underZero/nrow(tmp.dataset)*100,2),
  sep=""
)  
}  
```