```{r}
library(RCurl)
importAMCC <- c('R-dygraphsFunction.r','R-dataTablesFunction.r','R-turningPoint.r',
                'transposeDataFrame.r','plotTimeSeries.r')
for(iii in 1:length(importAMCC)){
  script <- getURL(
    paste0("https://raw.githubusercontent.com/am-consulting/am-consulting.github.io/master/",importAMCC[iii]),
    ssl.verifypeer = F
  )
  eval(parse(text = script))
}
```

```{r}
library(grid);library(gridExtra);library(XLConnect);library(quantmod)
options(scipen = 999)
windowsFonts(Meiryo = windowsFont("Meiryo"))
username <- Sys.info()['user']
pathOutput <-
  paste("C:/Users/", username, "/Desktop/R_Data_Write/", sep = "")
setwd(pathOutput)
fileName <- 'psw09.xls'
```

```{r}
if(!file.exists(paste0(pathOutput, fileName))) {
download.file(paste0('http://ir.eia.gov/wpsr/', fileName), fileName , mode = "wb")
}
```

```{r}
# tmp0 <- getSymbols('DCOILWTICO', src = 'FRED', auto.assign = F)
# tmp <-
#   data.frame(
#     Date = as.Date(index(tmp0)),
#     tmp0[, 1],
#     check.names = F,
#     row.names = NULL
#   )
# colnames(tmp)[2] <- 'Crude Oil Prices: West Texas Intermediate (WTI) - Cushing, Oklahoma(Dollars per Barrel)'
# wtiOil <- tmp
```

```{r}
targetSheet <- c(2:22)
dateFormat <- '%Y-%m-%d'
for (sss in 1:length(targetSheet)) {
  buf <-
    readWorksheetFromFile(
      paste0(pathOutput, fileName),
      sheet = targetSheet[sss]   ,
      check.names = F,
      header = F
    )
  colnames(buf) <-  unlist(buf[3,])
  buf <- buf[-c(1:3),]
  if (sss == 1) {
    EIAData <- buf
  } else{
    EIAData <- merge(EIAData, buf, by = 'Date', all = T)
  }
}
EIAData[, 1] <- as.Date(EIAData[, 1])
EIAData <- EIAData[order(EIAData[, 1]),]
EIAData <-
  data.frame(EIAData[, 1, drop = F], apply(EIAData[, -1], 2, as.numeric), check.names = F)
obj <- c(
  'Weekly U.S. Ending Stocks excluding SPR of Crude Oil  ',
  'Weekly Cushing, OK Ending Stocks excluding SPR of Crude Oil  ',
  'Weekly U.S. Ending Stocks of Total Gasoline  ',
  'Weekly U.S. Ending Stocks of Distillate Fuel Oil  ',
  'Weekly U.S. Ending Stocks of Propane and Propylene  ',
  'Weekly U.S. Refiner Net Input of Crude Oil  ',
  'Weekly U.S. Percent Utilization of Refinery Operable Capacity ',
  'Weekly U.S. Imports of Crude Oil  ',
  'Weekly U.S. Imports of Total Gasoline  '
)
JapaneseTitle <- c(
  '戦略石油備蓄を除いた週間米国原油在庫量(1000バレル)',
  '戦略石油備蓄を除いたオクラホマ州クッシングの週間米国原油在庫量(1000バレル)',
  '週間米国ガソリン在庫量(1000バレル)',
  '週間米国留出油在庫量(1000バレル)',
  '週間米国プロパンおよびプロピレン在庫量(1000バレル)',
  '週間米国製油所原油処理量(1000バレル/日)',
  '週間米国製油所稼働率(%)',
  '週間米国原油輸入量(1000バレル/日)',
  '週間米国ガソリン輸入量(1000バレル/日)'
)
```

```{r}
imageWidth <- 1920; imageHeight <- 1080
htmlFile <- paste0(Sys.Date(),'-amcc_EIA.md')
durationYear <- 10
cat('', file = htmlFile, append = F)
cat('<style>table{width:100%}</style>', file = htmlFile, append = T)
for (ooo in 1:length(obj)) {
  ccc <- grep(obj[ooo] , colnames(EIAData))
  tmp <- EIAData[, c(1, ccc)]
  tmp0 <- data.frame(tmp[-1, ], round(diff(tmp[, 2]), 10), check.names = F)
  colnames(tmp0)[3] <- '前週差' # 'Changes from last week'
  if(length(grep('percent', obj[ooo], ignore.case = T)) == 0){
    tmp0 <- data.frame(tmp0, round(diff(tmp[, 2])/head(tmp[,2],-1)*100,1), check.names = F)
    colnames(tmp0)[4] <- '前週比(%)' # 'Changes from last week(%)'
  }
  dataSet <- na.omit(tail(tmp0, ceiling(365 * durationYear / 7 )))
  # wtiOil0 <- na.omit(subset(wtiOil, first(dataSet[, 1]) <= wtiOil[, 1] & wtiOil[, 1] <= last(dataSet[, 1])))
  # dataSet <- merge(dataSet,wtiOil0,by='Date',all = T)
  cat('\n***\n', file = htmlFile, append = T)
  cat('<b>',paste0(colnames(dataSet)[2], '</b><br>'), file = htmlFile, append = T)
  cat('<b>',paste0(JapaneseTitle[ooo], '</b>\n\n'), file = htmlFile, append = T)
  dataSet0 <- na.omit(dataSet)
  colnames(dataSet0)[2] <- '結果'
  bufTable0 <- tail(dataSet0, 10)
  cat(paste0(knitr::kable(bufTable0,row.names = F), '\n'), file = htmlFile, append = T)  
  png.file <- paste0('EIA', ooo, ".png")
  png(file = png.file, width = imageWidth, height = imageHeight)
  fun_plotTimeSeries(obj = dataSet,
                     chartType = 0, objX = 1, objYL = 2, typeL = 'l',
                     dataTitle = JapaneseTitle[ooo],
                     dataSource = 'U.S. Energy Information Administration (EIA)',
                     cex.axis = 2.5, cex.main = 2.5, cex.lab = 2.0, 
                     mar = c(6, 6, 13, 4), needLefLab = 0,
                     lwdL = 2, fitLcolor = 2)
  amccTheme <- 
    gridExtra::ttheme_minimal(
      core = list(fg_params = list(hjust=1, cex = 3.0, x = 1)),
      colhead = list(fg_params = list(hjust=1, cex = 3.0, x = 1)),
      rowhead = list(fg_params = list(hjust=1, cex = 3.0, x = 1)))
  pushViewport(viewport(x = .2, y = .65))
  grid.table(cbind(summary(na.omit(dataSet[,2]))), theme = amccTheme)
  pushViewport(viewport(x = .8, y = .4))
  grid.table(bufTable0, theme = amccTheme, rows = NULL)
  abline(h = summary(na.omit(dataSet[,2]))[2], col = 'lightcoral')
  text(x = head(dataSet[,1],1) ,y = summary(na.omit(dataSet[,2]))[2],labels = '1st Qu.', pos = 4, cex = 3)
  abline(h = summary(na.omit(dataSet[,2]))[5], col = 'lightcoral')
  text(x = head(dataSet[,1],1) ,y = summary(na.omit(dataSet[,2]))[5],labels = '3rd Qu.', pos = 4, cex = 3)
  dev.off()
  png.file <- paste0('EIA', ooo, "-ACF.png")
  png(file = png.file, width = imageWidth, height = imageHeight)
  par(family = 'Meiryo', mar =c(10,10,13,10))
  acfResult0 <-
    na.omit(dataSet)
  acfResult <-
    acf(acfResult0[,2],
        plot = T,
        lag.max = 52 * 3,
        col = 'blue',
        main = NA,
        lwd = 2,
        panel.first = grid(nx = NULL,
                           ny = NULL,
                           lty = 2,
                           equilogs = T),
        cex.axis = 2.5, cex.lab = 2.5)
  mtext(text = paste0('自己相関係数\n',
                      colnames(acfResult0)[2],
                      '\n',
                      JapaneseTitle[ooo],
                      '\n',
                      paste0(range(acfResult0[,1]),collapse = '~')), 
        side = 3,
        cex = 3.0)
  acfResult <-
    data.frame(acfResult$lag, acfResult$acf)
  colnames(acfResult) <- 
    c('Lag','ACF')
  # plot, chart 内にデーブルを表示
  # 参照 ftp://cran.r-project.org/pub/R/web/packages/gridExtra/vignettes/tableGrob.html
  dev.off()
}
```
