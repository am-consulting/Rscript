```{r}
funPlotTimeSeries <- function() {
  imageWidth <- 1920
  imageHeight <- 1080
  png.file <- paste0('EIA', ooo, ".png")
  png(file = png.file, width = imageWidth, height = imageHeight)
  par(mar = c(6, 6, 13, 6), family = 'Meiryo')
  plot(
    dataSet[, 1],
    dataSet[, 2],
    type = 'h',
    col = 'blue',
    xlab = '' ,
    ylab = '' ,
    panel.first = grid(nx = NULL, ny = NULL, lty = 2, equilogs = T, lwd = 2) ,
    xaxt = 'n',
    main = paste(colnames(dataSet)[2], '\n',
      JapaneseTitle[ooo], '\n',
      format(first(dataSet[, 1]), dateFormat), '~',
      format(last(dataSet[, 1]),  dateFormat), '\nSource:U.S. Energy Information Administration (EIA) '
    ),
    cex.axis = 2.5, cex.main = 3, lwd = 2
  )
  # loessData <- na.omit(dataSet[,c(1,2)])
  # lo <- loess(loessData[, 2] ~ as.numeric(loessData[, 1]))  
  # lines(loessData[, 1] , predict(lo) , col = 'blue', lwd = 2, lty = 2,type = 'o')  
  loessData <- dataSet[,c(1,2)]
  loessData[, 2] <- na.approx(loessData[, 2])
  lo <- loess(loessData[, 2] ~ as.numeric(loessData[, 1]))
  lines(loessData[, 1] , predict(lo) , col = 'blue', lwd = 2, lty = 2)
  par(new=T)
  plot(
    dataSet[, 1],
    dataSet[, 4],
    type = 'l',
    col = 'red',
    xlab = '' ,
    ylab = '' ,
    panel.first = grid(nx = NULL, ny = NULL, lty = 2, equilogs = T, lwd = 2) ,
    xaxt = 'n',
    yaxt = 'n',
    lwd = 2
  )
  loessData <- na.omit(dataSet[,c(1,4)])
  lo <- loess(loessData[, 2] ~ as.numeric(loessData[, 1]))
  lines(loessData[, 1] , predict(lo) , col = 'red', lwd = 2, lty = 2)
  axis(4, cex.axis = 2.5, las = 0, padj = 0.5)
  mtext(colnames(dataSet)[2],  side = 2,  line = 3.2,  cex = 2)
  mtext(colnames(dataSet)[4],  side = 4,  line = 3.2,  cex = 2)
  axis.Date(side = 1, at = dataSet[, 1], format = dateFormat, padj = 1, cex.axis = 2)
  graphics::legend(
    'topleft',col=c('blue','red'),lty=1,legend=c(colnames(dataSet)[2],colnames(dataSet)[4]),cex=2.5,bty='n')
  dev.off()
}
```

```{r}
library(XLConnect)
library(dplyr)
library(quantmod)
library(zoo)
options(scipen = 999)
windowsFonts(Meiryo = windowsFont("Meiryo"))
username <- Sys.info()['user']
pathOutput <-
  paste("C:/Users/", username, "/Desktop/R_Data_Write/", sep = "")
setwd(pathOutput)
fileName <- 'psw09.xls'
```

```{r}
if(!file.exists(paste0(pathOutput, fileName))) {
download.file(paste0('http://ir.eia.gov/wpsr/', fileName), fileName , mode = "wb")
}
```

```{r}
tmp0 <- getSymbols('DCOILWTICO', src = 'FRED', auto.assign = F)
tmp <-
  data.frame(
    Date = as.Date(index(tmp0)),
    tmp0[, 1],
    check.names = F,
    row.names = NULL
  )
colnames(tmp)[2] <- 'Crude Oil Prices: West Texas Intermediate (WTI) - Cushing, Oklahoma(Dollars per Barrel)'
wtiOil <- tmp
```

```{r}
targetSheet <- c(2:22)
dateFormat <- '%Y-%m-%d'
for (sss in 1:length(targetSheet)) {
  buf <-
    readWorksheetFromFile(
      paste0(pathOutput, fileName),
      sheet = targetSheet[sss]   ,
      check.names = F,
      header = F
    )
  colnames(buf) <-  unlist(buf[3,])
  buf <- buf[-c(1:3),]
  if (sss == 1) {
    EIAData <- buf
  } else{
    EIAData <- merge(EIAData, buf, by = 'Date', all = T)
  }
}
EIAData[, 1] <- as.Date(EIAData[, 1])
EIAData <- EIAData[order(EIAData[, 1]),]
EIAData <-
  data.frame(EIAData[, 1, drop = F], apply(EIAData[, -1], 2, as.numeric), check.names = F)
obj <- c(
  'Weekly U.S. Ending Stocks excluding SPR of Crude Oil  ',
  'Weekly Cushing, OK Ending Stocks excluding SPR of Crude Oil  ',
  'Weekly U.S. Ending Stocks of Total Gasoline  ',
  'Weekly U.S. Ending Stocks of Distillate Fuel Oil  ',
  'Weekly U.S. Ending Stocks of Propane and Propylene  ',
  'Weekly U.S. Refiner Net Input of Crude Oil  ',
  'Weekly U.S. Percent Utilization of Refinery Operable Capacity ',
  'Weekly U.S. Imports of Crude Oil  ',
  'Weekly U.S. Imports of Total Gasoline  '
)
JapaneseTitle <- c(
  '戦略石油備蓄を除いた週間米国原油在庫量(1000バレル)',
  '戦略石油備蓄を除いたオクラホマ州クッシングの週間米国原油在庫量(1000バレル)',
  '週間米国ガソリン在庫量(1000バレル)',
  '週間米国留出油在庫量(1000バレル)',
  '週間米国プラパンおよびプロピレン在庫量(1000バレル)',
  '週間米国製油所原油処理量(1000バレル/日)',
  '週間米国製油所稼働率(%)',
  '週間米国原油輸入量(1000バレル/日)',
  '週間米国ガソリン輸入量(1000バレル/日)'
)
```

```{r}
htmlFile <- paste0(Sys.Date(),'-amcc_EIA.md')
cat('', file = htmlFile, append = F)
for (ooo in 1:length(obj)) {
  ccc <- grep(obj[ooo] , colnames(EIAData))
  tmp <- EIAData[, c(1, ccc)]
  tmp0 <- data.frame(tmp[-1, ], round(diff(tmp[, 2]), 10), check.names = F)
  colnames(tmp0)[3] <- 'Changes from last week'
  dataSet <- na.omit(tail(tmp0, ceiling(365 * 5 / 7 )))
  wtiOil0 <- na.omit(subset(wtiOil, first(dataSet[, 1]) <= wtiOil[, 1] & wtiOil[, 1] <= last(dataSet[, 1])))
  dataSet <- merge(dataSet,wtiOil0,by='Date',all = T)
  cat('\n***\n', file = htmlFile, append = T)
  cat('#### ',paste0(colnames(tmp0)[2], ' / ', JapaneseTitle[ooo], '\n'), file = htmlFile, append = T)
  colnames(tmp0)[2] <- 'Figure'
  bufTable <- tail(tmp0, 5)
  bufTable <- knitr::kable(bufTable,row.names = F)  
  cat(paste0(bufTable, '\n'), file = htmlFile, append = T)  
  # bufTable[, 1] <- format(bufTable[, 1], dateFormat)
  # bufTable[, 1] <- paste0('|', bufTable[, 1], '|')
  # bufTable[, 2] <- paste0(bufTable[, 2], '|')
  # bufTable[, 3] <- paste0(bufTable[, 3], '|')
  # mdTable <- c('|-:|', '-:|', '-:|')
  # mdTableHead <- c(paste0('|', colnames(bufTable)[1], '|'),
  #                  paste0(colnames(bufTable)[2], '|'),
  #                  paste0(colnames(bufTable)[3], '|'))
  # bufTable0 <- rbind(mdTableHead,
  #                    mdTable,
  #                    bufTable)
  # write.table(
  #   bufTable0,
  #   file = htmlFile,
  #   append = T,
  #   row.names = F,
  #   col.names = F ,
  #   quote = F
  # )
  summaryTable <- data.frame(unclass(summary(dataSet[,2:3])), check.names = F, stringsAsFactors = F)
  colnames(summaryTable) <- paste0(colnames(summaryTable), ':', first(dataSet[, 1]), '~', last(dataSet[, 1]))
  summaryTable <- knitr::kable(summaryTable)
  cat('<br> **基本統計量** \n\n', file = htmlFile, append = T)
  cat(paste0(summaryTable, '\n'), file = htmlFile, append = T)
  funPlotTimeSeries()
}
summaryTable <- data.frame(unclass(summary(dataSet[,4,drop=F])), check.names = F, stringsAsFactors = F)
colnames(summaryTable) <- paste0(colnames(summaryTable), ':', first(dataSet[, 1]), '~', last(dataSet[, 1]))
summaryTable <- knitr::kable(summaryTable)
cat('\n***\n', file = htmlFile, append = T)
cat('#### ',paste0(colnames(dataSet)[4]), file = htmlFile, append = T)
cat('<br> **基本統計量** \n\n', file = htmlFile, append = T)
cat(paste0(summaryTable, '\n'), file = htmlFile, append = T)
```