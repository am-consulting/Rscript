```{r}
#library
options("getSymbols.warning4.0"=F)
library(quantmod)
library(ggplot2)
library(gridExtra)
library(knitr)
library(scales)
library(tseries)
library(PerformanceAnalytics)
library(reshape2)
library(urca)
library(lubridate)
library(stringr)
library(forecast)
library(fGarch)
library(vars)
library(MSwM)
library(tsDyn)
add.ver<-gsub("\\.","",paste("?var=",year(Sys.Date()),month(Sys.Date()),day(Sys.Date()),hour(Sys.time()),minute(Sys.time()),second(Sys.time()),sep=""))
#list
dataset<-list()
dataset.yy<-list()
dataset.xts<-list()
dataset.xts.yy<-list()
all.data<-list()
all.data.yy<-list()
all.data.xts<-list()
all.data.xts.yy<-list()
timeline<-list()
dataset.tm<-list()
js.title<-list()
#parameter
username<-Sys.info()['user']
path<-paste("C:/Users/",username,"/Desktop",sep="")
pathOutput<-paste("C:/Users/",username,"/Desktop/R_Data_Write/",sep="")
pathInput<-paste("C:/Users/",username,"/Desktop/inputR/",sep="")
cnt<-0
##make dataset.tm[[x]]
timeline[[1]]<-c(
"1946-5-22","吉田茂",
"1947-5-24","片山哲",
"1948-3-10","芦田均",
"1948-10-15","吉田茂",
"1954-12-10","鳩山一郎",
"1956-12-23","石橋湛山",
"1957-2-25","岸信介",
"1960-7-19","池田勇人",
"1964-11-9","佐藤栄作",
"1972-7-7","田中角栄",
"1974-12-9","三木武夫",
"1976-12-24","福田赳夫",
"1978-12-7","大平正芳",
"1980-7-17","鈴木善幸",
"1982-11-27","中曽根康弘",
"1987-11-6","竹下登",
"1989-6-3","宇野宗佑",
"1989-8-10","海部俊樹",
"1991-11-5","宮沢喜一",
"1993-8-9","細川護熙",
"1994-4-28","羽田孜",
"1994-6-30","村山富市",
"1996-1-11","橋本龍太郎",
"1998-7-30","小渕恵三",
"2000-4-5","森喜朗",
"2001-4-26","小泉純一郎",
"2006-9-26","安倍晋三",
"2007-9-26","福田康夫",
"2008-9-24","麻生太郎",
"2009-9-16","鳩山由紀夫",
"2010-6-8","菅直人",
"2011-9-2","野田佳彦",
"2012-12-26","安倍晋三(2次-)"
)
timeline[[2]]<-c(
"1946-6-1","一万田尚登",
"1954-12-11","新木榮吉",
"1956-11-30","山際正道",
"1964-12-17","宇佐美洵",
"1969-12-17","佐々木直",
"1974-12-17","森永貞一郎",
"1979-12-17","前川春雄",
"1984-12-17","澄田智",
"1989-12-17","三重野康",
"1994-12-17","松下康雄",
"1998-3-20","速水優",
"2003-3-20","福井俊彦",
"2008-4-9","白川方明",
"2013-3-20","黒田東彦"
)
timeline[[3]]<-c(
"1949-1-20","Harry S. Truman",
"1953-1-20","Dwight David Eisenhower",
"1961-1-20","John Fitzgerald Kennedy",
"1963-11-22","Lyndon Baines Johnson",
"1969-1-20","Richard Milhouse Nixon",
"1974-8-9","Gerald Rudolph Ford Jr.",
"1977-1-20","James Earl Carter",
"1981-1-20","Ronald Wilson Reagan",
"1989-1-20","George H.W Bush",
"1993-1-20","Bill Clinton",
"2001-1-20","George W. Bush",
"2009-1-20","Barack Obama"
)
timeline[[4]]<-c(
"1970-2-1","Arthur F.Burns",
"1978-3-8","G.William Miller",
"1987-8-11","Alan Greenspan",
"2006-2-1","Ben S.Bernanke",
"2014-2-1","Janet Yellen"
)
for(ttt in 1:4){
  tmp<-timeline[[ttt]]
  inaugural.date<-as.Date(tmp[seq(1,length(tmp),by=2)])
  resignation.date<-c((inaugural.date-1)[-1],Sys.Date()+31)
  Name<-tmp[seq(2,length(tmp),by=2)]
  dataset.tm[[ttt]]<-data.frame(inaugural.date,resignation.date,Name)
  dataset.tm[[ttt]][,3]<-ordered(dataset.tm[[ttt]][,3],levels=dataset.tm[[ttt]][,3][1:nrow(dataset.tm[[ttt]])])
  order(dataset.tm[[ttt]][,3])
}
####################################################### functions #######################################################
##separate data into individual datasets
fun.individual<-function(tmp,monthly){
  for(ccc in 2:ncol(tmp)){
    cnt<<-cnt+1 #caution.gloval variable
    dataset[[cnt]]<-tmp[,c(1,ccc)]
    dataset[[cnt]][,2]<-gsub("\\s", "",dataset[[cnt]][,2]) #remove space
    dataset[[cnt]]<-subset(dataset[[cnt]],dataset[[cnt]][,2]!="") #remove blank row
    dataset[[cnt]][,2]<-as.double(dataset[[cnt]][,2])
    colnames(dataset[[cnt]])[1]<-"Date"
    if(monthly==1){#月次データの日付は月末に変更
      dataset[[cnt]][,1]<-as.Date(paste(year(dataset[[cnt]][,1]),"-",month(dataset[[cnt]][,1]),"-",days_in_month(dataset[[cnt]][,1]),sep=""))
    }
    #omit part  
    dataset[[cnt]]<-subset(dataset[[cnt]],is.infinite(dataset[[cnt]][,2])!=T) 
    dataset[[cnt]]<-na.omit(dataset[[cnt]])  
    #omit part  
    #共通列名変更  
    colnames(dataset[[cnt]])[2]<-gsub("\\.億円","",colnames(dataset[[cnt]])[2], perl=T)  
    colnames(dataset[[cnt]])[2]<-gsub("\\.q\\.","",colnames(dataset[[cnt]])[2], perl=T)#ETF購入 
    colnames(dataset[[cnt]])[2]<-gsub("\\.\\.","\\.",colnames(dataset[[cnt]])[2], perl=T)#国内企業物価指数 
    colnames(dataset[[cnt]])[2]<-gsub("X\\.","",colnames(dataset[[cnt]])[2], perl=T)#国内企業物価指数 
    #共通列名変更  
    dataset[[cnt]]<<-dataset[[cnt]] #caution.gloval variable
    print(head(dataset[[cnt]],2))
    print(tail(dataset[[cnt]],2))
  }
}
##calculate for tmp.0,tmp.1 and tmp.date
fun.common<-function(ppp,iii,ttt){#現在、時系列チャートチャンクのみで利用
  if(ppp==1){
    tmp.date<-max(as.Date(first.date[ttt]),na.omit(dataset[[obj[iii]]])[1,1])
    tmp.1<-na.omit(subset(dataset[[obj[iii]]],tmp.date<=dataset[[obj[iii]]][,1]))
  }else{
    tmp.date<-max(as.Date(first.date[ttt]),na.omit(dataset.yy[[obj[iii]]])[1,1])
    tmp.1<-na.omit(subset(dataset.yy[[obj[iii]]],tmp.date<=dataset.yy[[obj[iii]]][,1]))
  }
  for(kkk in seq(1,nrow(dataset.tm[[ttt]]),by=1)){
    if(dataset.tm[[ttt]][kkk,1]<=tmp.date & tmp.date<=dataset.tm[[ttt]][kkk,2]){break}  
  }
  tmp.0<-dataset.tm[[ttt]][c(kkk:nrow(dataset.tm[[ttt]])),]
  if(nrow(tmp.0)!=0){
    tmp.0[1,1]<-tmp.date
    tmp.0[nrow(tmp.0),2]<-last(tmp.1)[1]
  }else{
    tmp.0<-last(dataset.tm[[ttt]])
    tmp.0[1,1]<-tmp.date
    tmp.0[1,2]<-last(tmp.1)[1]
  }
  tmp.1<<-tmp.1 #caution
  tmp.0<<-tmp.0 #caution
  tmp.date<<-tmp.date #caution
}
#Convert dataframe to xts
fun.convert<-function(){
  for(iii in 1:cnt){
    cat(paste(iii,colnames(dataset[[iii]])[2],"\n")) 
    dataset.xts[[iii]]<-as.xts(dataset[[iii]][,-1],order.by=as.Date(dataset[[iii]][,1]))
    colnames(dataset.xts[[iii]])[1]<-colnames(dataset[[iii]])[2]
    dataset.xts[[iii]]<<-dataset.xts[[iii]]
  }
  #merge all datasets
  obj<-c(1:length(dataset.xts))
  for(iii in 1:length(obj)){
    if(iii==1){
      all.data.xts[[1]]<-dataset.xts[[obj[iii]]]
    }else{
      all.data.xts[[1]]<-merge.xts(all.data.xts[[1]],dataset.xts[[obj[iii]]],all=T)
    }
  }
  all.data[[1]]<-data.frame(date=index(all.data.xts[[1]]),all.data.xts[[1]],row.names=NULL)
  all.data[[1]]<<-all.data[[1]]
  all.data.xts[[1]]<<-all.data.xts[[1]]
  obj<<-obj
}
#year-to-year change
fun.yeartoyear<-function(){
  if(plot.type==2){
    for(ddd in 1:cnt){
      tmp<-na.omit(dataset.xts[[ddd]])
      if(yy.type<=nrow(tmp)){
        tmp<-round(diff(tmp,lag=yy.type)/lag(tmp,yy.type)*100,2)[-1]
        
        tmp<-subset(tmp,is.infinite(tmp[,1])==F)
        tmp<-subset(tmp,is.na(tmp[,1])==F)
        tmp<-subset(tmp,is.nan(tmp[,1])==F)
        
        dataset.xts.yy[[ddd]]<-tmp
        colnames(dataset.xts.yy[[ddd]])<-paste("YoY_pc_",colnames(dataset.xts.yy[[ddd]]),sep="")
        dataset.yy[[ddd]]<-data.frame(date=index(dataset.xts.yy[[ddd]]),dataset.xts.yy[[ddd]],row.names=NULL)
        if(ddd==1){all.data.xts.yy[[1]]<-tmp}else{all.data.xts.yy[[1]]<-merge.xts(all.data.xts.yy[[1]],tmp,all=T)}
        colnames(all.data.xts.yy[[1]])<-paste("YoY_pc_",colnames(all.data.xts.yy[[1]]),sep="")
        dataset.xts.yy[[ddd]]<<-dataset.xts.yy[[ddd]]
        colnames(dataset.yy[[ddd]])[1]<-"Date"
        dataset.yy[[ddd]]<<-dataset.yy[[ddd]]
      }
    }
    all.data.yy[[1]]<-data.frame(date=index(all.data.xts.yy[[1]]),all.data.xts.yy[[1]],row.names=NULL)
    all.data.yy[[1]]<<-all.data.yy[[1]]
    all.data.xts.yy[[1]]<<-all.data.xts.yy[[1]]
  }
}

fun.gettitle<-function(){
  gettitle<-colnames(tmp.1)[2]
  gettitle<-gsub("YoYchange.percent.","YoYchange.percent\n",gettitle, perl=T)
  gettitle<-sub("\\.", "\n", gettitle)#最初のドットのみとする
  if(monthly==1){
    gettitle<-paste(format(tmp.1[1,1],"%Y-%m"),"-",format(tmp.1[nrow(tmp.1),1],"%Y-%m"),"\n",gettitle)
  }else{
    gettitle<-paste(tmp.1[1,1],"-",tmp.1[nrow(tmp.1),1],"\n",gettitle)
  }
  gettitle<<-gettitle
}
fun.omit<-function(tmp.omit){#都度必要に応じて利用
  tmp.omit<-subset(tmp.omit,is.infinite(tmp.omit[,2])!=T) 
  tmp.omit<-na.omit(tmp.omit)
  tmp.omit<<-tmp.omit
}  
fun.withkeyposition<-function(){
#本ループで日付、データ値、PM(USA)、BOJ(FRB)のデータフレーム作成
for(ttt in ttt.range){
  if(chk==0){
    if(ppp==1){
      tmp.0<-dataset[[obj[iii]]]
    }else{
      tmp.0<-dataset.yy[[obj[iii]]]
    }
    chk<-1
  }
  if(nrow(tmp.0)!=0){
    for(jjj in 1:nrow(tmp.0)){
      for(kkk in seq(nrow(dataset.tm[[ttt]]),1,by=-1)){
        if(dataset.tm[[ttt]][kkk,1]<=tmp.0[jjj,1] & tmp.0[jjj,1]<=dataset.tm[[ttt]][kkk,2]){
          tmp.0[jjj,ttt+ttt.diff]<-dataset.tm[[ttt]][kkk,3]
          break
        }  
      }
    }
    if(ttt==2){colnames(tmp.0)[ttt.diff+1]<-"PM";colnames(tmp.0)[ttt.diff+2]<-"BoJ"}
    if(ttt==4){colnames(tmp.0)[ttt.diff+3]<-"U.S.A";colnames(tmp.0)[ttt.diff+4]<-"FRB"}
    tmp0<-1
  }else{
    tmp0<-0
  }
  tmp.0<-na.omit(tmp.0)
  tmp.0<<-tmp.0  
  tmp0<<-tmp0 
  ttt<<-ttt
}
#本ループで日付、データ値、PM(USA)、BOJ(FRB)のデータフレーム作成
}
####################################################### functions #######################################################
####################################################### argument  #######################################################

####################################################### argument  #######################################################
```

```{r}
#read data from bank of japan as data frame
exe<-1
monthly<-1 # 0 or 1
plot.type<-2
ttt.range<-c(1:2)
yy.type<-12 #12 month,4 period
level.multi<-(0)
if(exe==1){
  folder.path<-file.path(pathInput)
  setwd(folder.path)
  tmp<-read.csv(file=dir(folder.path),header=F,as.is=T,skip=0,na.strings=c("", "NA"))
  folder.path<-paste("C:/Users/",username,tmp[2,2],sep="")
  setwd(folder.path)
  if(length(dir(folder.path))!=0){
    for(fff in 1:length(dir(folder.path))){
      cnt.start<-cnt+1
      tmp<-read.csv(file=dir(folder.path)[fff],header=T,as.is=T,skip=1,na.strings=c("", "NA"))
      colnames(tmp)<-paste(colnames(tmp),".",tmp[2,],sep="")
      tmp<-tmp[-c(1:12),]
      if(monthly==1){
        tmp[,1]<-paste(tmp[,1],"/1",sep="")
        tmp[,1]<-as.Date(tmp[,1])
      }
      fun.individual(tmp,monthly)
      for(zzz in cnt.start:cnt){
        js.title[[zzz]]<-gsub("\\.csv","",dir(folder.path)[fff])
      }  
    }
  }
}
fun.convert()
fun.yeartoyear()
```

```{r}
#read various sorts of data of which class is data frame
select.data<-6 # 1others 2BankofJapan 3yearlyData 4monthlyData 5dailyData 6quarterlyData
exe<-1
monthly<-1 # 0 or 1
plot.type<-1
ttt.range<-c(1:2)
yy.type<-12 #12 month,4 period
level.multi<-(0)
if(exe==1){
  folder.path<-file.path(pathInput)
  setwd(folder.path)
  tmp<-read.csv(file=dir(folder.path),header=F,as.is=T,skip=0,na.strings=c("", "NA"))
  folder.path<-paste("C:/Users/",username,tmp[select.data,2],sep="")
  setwd(folder.path)
  if(length(dir(folder.path))!=0){
    for(iii in 1:length(dir(folder.path))){
      cnt.start<-cnt+1
      tmp<-read.table(file=dir(folder.path)[iii],header=TRUE,sep=",",na.strings=c("NA","-",""))
      tmp[,1]<-as.Date(tmp[,1])
      FUN.1<-function(x) as.numeric(gsub("[( | ) | -+ | , | < | >]","",x))
      tmp<-data.frame(tmp[1],apply(tmp[-1],2,FUN.1))
      fun.individual(tmp,monthly)
      for(zzz in cnt.start:cnt){
        js.title[[zzz]]<-gsub("\\.csv","",dir(folder.path)[iii])
      }  
    }
  }
}
fun.convert()
fun.yeartoyear()
```

```{r}
#read data from fred by quantmod as xts,after that, convert to data frame
exe<-1
monthly<-0 # 0 or 1
plot.type<-1
ttt.range<-c(1:2)
yy.type<-12 #12 month,4 period
level.multi<-(0)
if(exe==1){
  ts.source<-list()
  ts.source[[1]]<-c("FRED",1,"DGS10","GOLDAMGBD228NLBM","DCOILWTICO","NIKKEI225","SP500","DJIA","NASDAQ100")
  ts.source[[1]]<-c("FRED",1,"DTWEXM","DEXJPUS","DEXUSEU","DEXUSUK","DEXUSAL","DEXNOUS","DEXSZUS","DEXSFUS","DEXKOUS","DEXUSNZ")
# UNRATE CPIAUCSL HOUSTNSA EXJPUS 
#  ts.source[[1]]<-c("FRED",1,"M2V","A191RL1Q225SBEA")# M2V A191RL1Q225SBEA CP0000EZ17M086NEST CPIAUCSL "PAYEMS","MANEMP","UNRATE" "AMBNS","UNRATENSA" CPIAUCNS HOUSTNSA
#  ts.source[[1]]<-c("FRED",1,"EXJPUS")# M2V A191RL1Q225SBEA CP0000EZ17M086NEST CPIAUCSL "PAYEMS","MANEMP","UNRATE" "AMBNS","UNRATENSA" CPIAUCNS HOUSTNSA
  for(lll in 1:length(ts.source)){
    if(2<length(ts.source[[lll]])){
      for(iii in 3:length(ts.source[[lll]])){
        item<- ts.source[[lll]][iii]
        tmp<-getSymbols(item,src=ts.source[[lll]][1],auto.assign=FALSE)
        tmp<-tmp[,as.double(ts.source[[lll]][2])]
        tmp<-data.frame(date=index(tmp),tmp, row.names=NULL)
        fun.individual(tmp,monthly)
        js.title[[cnt]]<-ts.source[[1]][iii]
      }
    }
  }
}
fun.convert()
fun.yeartoyear()
dataset.type<-0 #0:single,1:multi 
```

```{r}
#read nikkei225 as data frame
exe<-1
monthly<-1
if(monthly==0){url.period<-"daily"}else{url.period<-"monthly"}
if(exe==1){
  url<-c(
  paste("http://indexes.nikkei.co.jp/nkave/historical/nikkei_stock_average_",url.period,"_en.csv",sep="")
  )
  for(iii in 1:length(url)){
    tmp<-read.csv(url[iii],header=T,skip=0,stringsAsFactor=F)
    tmp[,1]<-as.Date(tmp[,1])
    if(grepl("nikkei",url[iii])==T){
      colnames(tmp)[-1]<-paste("Nikkei.",colnames(tmp)[-1],sep="")
    }
    fun.individual(tmp,monthly)
  }
}
```

```{r}
#read TODAIDailyPriceIndex as data frame
exe<-0
monthly<-0
if(exe==1){
  url<-c(
  "http://www.cmdlab.co.jp/price_u-tokyo/download/HistoricalDailyData.csv"
  )
  for(iii in 1:length(url)){
    tmp<-read.csv(url[iii],header=T,skip=0,stringsAsFactor=F)
    tmp[,1]<-as.Date(tmp[,1])
    if(grepl("nikkei",url[iii])==T){
      colnames(tmp)[-1]<-paste("Nikkei.",colnames(tmp)[-1],sep="")
    }
    fun.individual(tmp,monthly)
  }
}
```

```{r}
#Japanese Government Bonds as data frame
exe<-1
monthly<-0
plot.type<-1
ttt.range<-c(1:2)
level.multi<-0
if(exe==1){
  url<-c(
  "http://www.mof.go.jp/english/jgbs/reference/interest_rate/historical/jgbcme_all.csv",
  "http://www.mof.go.jp/english/jgbs/reference/interest_rate/jgbcme.csv"
  )
  tmp<-rbind(read.csv(url[1],header=T,skip=0,stringsAsFactor=F),read.csv(url[2],header=T,skip=0,stringsAsFactor=F))
  tmp[,1]<-as.Date(tmp[,1])
  FUN.1<-function(x) as.numeric(x)
  tmp<-data.frame(tmp[1],apply(tmp[-1],2,FUN.1))
  colnames(tmp)[2:length(tmp)]<-paste("JGB.",gsub("X","",colnames(tmp)[2:length(tmp)]),"year",sep="")
  tmp<-tmp[,c(1,11)]#10年物のみを抽出
  fun.individual(tmp,monthly)
}
js.title[[1]]<-"JAPANESEGOVERNMENTBOND10YEAR"
fun.convert()
fun.yeartoyear()
dataset.type<-0 #0:single,1:multi 
```

```{r}
setwd(pathOutput)
outputhtml<-data.frame()
outputjs<-data.frame()
tablelistbasejs<-data.frame()
tablelistjs<-data.frame()
data.id<-c("tschart","boxplot","unitroot","acf","forecast","return","rank","garch","msm","setar")
for(uuuu in 1:length(unique(js.title))){
 fileCommonName<-unique(js.title)[uuuu]  
 tablelistjs[uuuu,1]<-paste(fileCommonName,".tablelist.js",sep="")
 cat("\n",file=tablelistjs[uuuu,1],append=F)  
 tablelistbasejs[uuuu,1]<-paste(fileCommonName,".tablelistbase.js",sep="")  
 cat("\n",file=tablelistbasejs[uuuu,1],append=F)
 for(bbbb in 1:10){
  outputjs[uuuu,bbbb]<-paste(fileCommonName,".external0",bbbb,".js",sep="")  
  outputhtml[uuuu,bbbb]<-paste(fileCommonName,data.id[bbbb],".html",sep="")
  cat("",file=outputhtml[uuuu,bbbb],append=F) 
  cat("\n\n$(function() {",file=outputjs[uuuu,bbbb],append=F)
  cat(paste("\n$.get('http://archive.am-consulting.co.jp/",outputhtml[uuuu,bbbb],add.ver,"', function(data) {",sep=""),file=outputjs[uuuu,bbbb],append=T)
  cat(paste("\n$('#",data.id[bbbb],"').html('<pre>' + data + '</pre>');",sep=""),file=outputjs[uuuu,bbbb],append=T)
  cat("\n});",file=outputjs[uuuu,bbbb],append=T)
  cat("\n});\n\n",file=outputjs[uuuu,bbbb],append=T)
 }
}
```

```{r}
#時系列チャート作成チャンク
setwd(pathOutput)
level.type<-1
first.date<-c("2001-4-26","1998-3-20","1993-1-20","1987-8-11")
bbbb<-1
for(uuuu in 1:length(unique(js.title))){
 buf.html<-outputhtml[uuuu,bbbb]
 count<-0
 for(iii in 1:length(obj)){
  if(as.character(unique(js.title)[uuuu])==as.character(js.title[iii])){
   count<-count+1
   for(ppp in 1:plot.type){
    for(ttt in ttt.range){
     fun.common(ppp,iii,ttt)
     if(nrow(tmp.1)!=0){
      fun.gettitle()
      switch(ppp,
      multi<-(10^level.multi),
      multi<-1
      )
      colnames(tmp.1)[2]<-"value"
      tmp.1[,2]<-tmp.1[,2]*multi 
      if(nrow(tmp.0)!=0){
       x0<-tmp.0$inaugural.date[seq(1,length(tmp.0$inaugural.date),by=2)]
       x1<-tmp.0$resignation.date[seq(1,length(tmp.0$resignation.date),by=2)]
      }else{
       x0<-tmp.0[1,1]
       x1<-tmp.0[1,2]
      }
      fun.omit(tmp.1)
      tmp.1<-tmp.omit
      y0<-min(tmp.1[,2])
      if(0<y0 && ppp==2){
       y0<-0
      }
      y1<-max(tmp.1[,2])
      shade<-data.frame(x0,x1,y0,y1)
      shade<<-subset(shade,as.Date(first.date[ttt])<=shade[,1])
      value.y<<-median(tmp.1[,2]) #value.y<<-mean(tmp.1[,2]) 
      png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,ttt,".png",sep="")
      png(file=png.file,width=1400,height=1200)  
      g<-ggplot()
      g<-g+geom_segment(data=tmp.0,aes(x=inaugural.date,xend=resignation.date,y=value.y,yend=value.y,colour=Name),size=10)
      g<-g+geom_rect(data=shade,aes(xmin=x0,xmax=x1,ymin=y0,ymax=y1),fill='gray80',alpha=0.4)
      if(ppp==1){
       if(level.type==1){
        g<-g+geom_line(data=tmp.1,aes(x=Date,y=value),size=2)
       }else{
        g<-g+geom_bar(data=tmp.1,aes(x=Date,y=value),stat="identity",position="identity",fill="blue",alpha=0.2,color="black")
       } #geom_bar:データが全てプラス値の場合、表示されない←y0<-0で解決
      }else{
       g<-g+geom_bar(data=tmp.1,aes(x=Date,y=value),stat="identity",position="identity",fill="blue",alpha=0.2,color="black")
      }
      g<-g+geom_smooth(data=tmp.1,aes(x=Date,y=value),method=lm)
      g<-g+geom_smooth(data=tmp.1,aes(x=Date,y=value),method=loess,color="red")
      g<-g+ggtitle(gettitle)+xlab("")+ylab("") 
      g<-g+ylim(y0,y1)
      g<-g+theme(axis.text=element_text(size=30),
      axis.title=element_text(size=50,face="bold"),title=element_text(size=60,face="bold"),
      legend.position="top",legend.text=element_text(colour="black",size=25,face="bold"),
      legend.title=element_text(colour="white",size=1,face="bold"))          
      g<-g+scale_x_date(labels=date_format("%y/%m"))
      print(g)
      dev.off() 
      cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
     }
    }
   }
  } 
 }
}
```

```{r}
######################################引数設定パート######################################    
exe.table<-1
exe.boxplot<-1
exe.unitroot<-1
exe.acf<-1
exe.forecast<-1
exe.return<-1
exe.rank<-1
exe.garch<-1
exe.msm<-1
exe.setar<-1
setwd(pathOutput)
if(monthly==1){
 acf.lag<-12*5#オリジナルデータの長さに注意
}else{
 acf.lag<-365*10
}
first.date<-c("2001-4-26","1998-3-20","1993-1-20","1987-8-11")
if(ttt.range[1]==1){
 ttt.diff<-2
}else{
 ttt.diff<-0
}
######################################引数設定パート###################################### 
for(uuuu in 1:length(unique(js.title))){
 count<-0 
 for(iii in 1:length(obj)){
  if(as.character(unique(js.title)[uuuu])==as.character(js.title[iii])){
   count<-count+1
  for(ppp in 1:plot.type){
   chk<-0#tttループ内で2回以上tmp.0を作成しないため
###################################### 共 通 パート ######################################
   fun.withkeyposition()
   if(tmp0==1){#条件分岐001
    row.names(tmp.0)<-NULL
    tmp.1<-tmp.0[,c(1:4)]
    switch(ppp,
     multi<-(10^level.multi),
     multi<-1
    )
    tmp.1[,2]<-tmp.1[,2]*multi
    fun.gettitle()
###################################### 共 通 パート ######################################
###################################### table パート ######################################
if(exe.table==1){#なおtmp.table[,2]<-format(tmp.table[,2],big.mark=",",scientific=F)とするとcsvのseparating commaを誤認識する
tmp.table<-tmp.1
fun.omit(tmp.table)  
tmp.table<-tmp.omit
tmp.table<-tmp.table[order(tmp.table$Date,decreasing=T),]
tmp.table<-head(tmp.table,24) # 180 365
rownames(tmp.table)<-NULL    
if(monthly==1){tmp.table[,1]<-format(tmp.table[,1],"%Y-%m")}
#個別csvデータの出力
csv.file.name<-paste(js.title[[iii]],ppp,count,".csv",sep="")    
write.csv(tmp.table[,1:2],csv.file.name,col.names=T,row.names=F,append=F,quote=F,fileEncoding="UTF-8")
#個別csvデータの出力
#csvリストの出力
csv.id<-paste(js.title[[iii]],"csv",ppp,count,sep="")
cat(paste("document.write('<div id=\"",csv.id,"\"></div>\');\n",sep=""),file=tablelistjs[uuuu,1],append=T)
#csvリストの出力
#csv表示仕樣の出力 
cat("$(function(){",file=tablelistbasejs[uuuu,1],append=T)     
cat(gsub("\\s","",paste("\n","$('#",csv.id,"').CSVToTable('http://archive.am-consulting.co.jp/",csv.file.name,add.ver,"',{startLine:0}).bind(\"loadComplete\",",sep="")),file=tablelistbasejs[uuuu,1],append=T)     
cat("\nfunction(){",file=tablelistbasejs[uuuu,1],append=T)
cat(gsub("\\s","",paste("\n$('#",csv.id,"').find('TABLE').dataTable(",sep="")),file=tablelistbasejs[uuuu,1],append=T)
cat("\n{",file=tablelistbasejs[uuuu,1],append=T)    
cat("\n\"lengthMenu\": [[5,-1], [5,\"All\"]],",file=tablelistbasejs[uuuu,1],append=T) 
cat("\n\"order\": [[ 0,\"desc\"]],",file=tablelistbasejs[uuuu,1],append=T)      
cat("\n\"bFilter\":false,",file=tablelistbasejs[uuuu,1],append=T)
cat("\n\"paging\":true,",file=tablelistbasejs[uuuu,1],append=T)
cat("\n\"columnDefs\":[{\"width\":\"30%\",\"targets\":0}],",file=tablelistbasejs[uuuu,1],append=T) 
cat("\n\"info\":true",file=tablelistbasejs[uuuu,1],append=T)
cat("\n}",file=tablelistbasejs[uuuu,1],append=T)    
cat("\n);",file=tablelistbasejs[uuuu,1],append=T)
cat("\n});;",file=tablelistbasejs[uuuu,1],append=T)    
cat("\n});\n\n",file=tablelistbasejs[uuuu,1],append=T)
#csv表示仕樣の出力 
} 
###################################### table パート ######################################    
###################################### boxplotパート######################################
if(exe.boxplot==1){
bbbb<-2 
buf.html<-outputhtml[uuuu,bbbb]
for(ttt in ttt.range){    
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,ttt,".png",sep="")  
 png(file=png.file,width=1400,height=1200)   
 tmp.boxplot<-tmp.1[,c(2,ttt+ttt.diff)]
 fun.omit(tmp.boxplot)
 tmp.boxplot<-tmp.omit
 colnames(tmp.boxplot)[2]<-"Person"  
 tmp.boxplot<-melt(tmp.boxplot,id="Person")
 tmp.boxplot<-tmp.boxplot[,-2]
 tmp.boxplot[,2]<-as.numeric(tmp.boxplot[,2])
 colnames(tmp.boxplot)[1]<-"variable"
 g<-ggplot(data=tmp.boxplot,aes(x=variable,y=value))
 g<-g+geom_boxplot(lwd=2)
 g<-g+ggtitle(gettitle)+xlab("")+ylab("")
 g<-g+theme(axis.text=element_text(size=40,color="black",angle=90,hjust=1),axis.title=element_text(size=30,face="bold"),title=element_text(size=45,face="bold")) 
 print(g)
 dev.off()
 cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
}
} 
###################################### boxplotパート######################################
#以降で適用するデータフレーム  
if(monthly==1){
 data.lag<-12*20#オリジナルデータの長さに注意
 tmp.1<-tail(tmp.1,data.lag)  
}else{
 data.lag<-as.Date(paste(year(Sys.Date())-5,"-",month(Sys.Date()),"-",day(Sys.Date()),sep=""))
 tmp.1<-subset(tmp.1,data.lag<=tmp.1[,1])  
}   
fun.gettitle()
######################################unitrootパート######################################    
if(exe.unitroot==1){ 
bbbb<-3 
buf.html<-outputhtml[uuuu,bbbb]
tmp.unitroot<-tmp.1[,c(1:2)]
if(nrow(subset(tmp.unitroot,tmp.unitroot[,2]!=0))!=0){
 fun.omit(tmp.unitroot)
 tmp.unitroot<-tmp.omit
 date.f.l<-as.Date(tmp.unitroot[1,1])
 date.e.l<-as.Date(tmp.unitroot[nrow(tmp.unitroot),1])
 date.f.d<-as.Date(tmp.unitroot[2,1])
 date.e.d<-date.e.l
 if(monthly==1){
  date.f.l<-format(date.f.l,"%Y-%m")
  date.e.l<-format(date.e.l,"%Y-%m")
  date.f.d<-format(date.f.d,"%Y-%m")
  date.e.d<-format(date.e.d,"%Y-%m")
 }else{
  date.f.l<-format(date.f.l,"%Y-%m-%d")
  date.e.l<-format(date.e.l,"%Y-%m-%d")
  date.f.d<-format(date.f.d,"%Y-%m-%d")
  date.e.d<-format(date.e.d,"%Y-%m-%d")
 }
 value.level<-tmp.unitroot[,2]
 value.1stDiff<-diff(tmp.unitroot[,2])
 tmp.unitroot.result<-capture.output(adf.test(value.level))
 tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)#検定統計量、p値、ラグを分割
 cat("\n<div align=\"center\"><b>",gettitle,"</b></div>","\n",file=buf.html,append=T)      
 cat("\nPeriod:",date.f.l,"-",date.e.l,file=buf.html,append=T)
 write(tmp.unitroot.result,file=buf.html,append=T)
 tmp.unitroot.result<-capture.output(adf.test(value.1stDiff))
 tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)#検定統計量、p値、ラグを分割
 cat("\nPeriod:",date.f.d,"-",date.e.d,file=buf.html,append=T)
 write(tmp.unitroot.result,buf.html,append=T)
 tmp.unitroot.xts<-as.xts(tmp.unitroot[,-1],order.by=as.Date(tmp.unitroot[,1]))
 tmp.xts.title<-colnames(tmp.unitroot)[2]
 colnames(tmp.unitroot.xts)[1]<-paste(tmp.xts.title,".レベル",sep="")
 tmp.unitroot.xts.diff<-diff(tmp.unitroot.xts)
 colnames(tmp.unitroot.xts.diff)[1]<-paste(tmp.xts.title,".1次階差",sep="")
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,".png",sep="")    
 png(file=png.file,width=1400,height=1200)
 par(mar=c(7, 5, 5, 5))
 if(monthly==1){
  maintitle.first<-format(first(index(tmp.unitroot.xts)),"%Y-%m")
  maintitle.last<-format(last(index(tmp.unitroot.xts)),"%Y-%m")
 }else{
  maintitle.first<-format(first(index(tmp.unitroot.xts)),"%Y-%m-%d")
  maintitle.last<-format(last(index(tmp.unitroot.xts)),"%Y-%m-%d")
 }  
 chart.TimeSeries(tmp.unitroot.xts,main=paste(maintitle.first,"-",maintitle.last),yaxis.right=F,type="l",lwd="4",legend.loc="bottomleft",color="blue",cex.main=6,cex.legend=3,cex.lab=4,ylab="",cex.axis=4) 
 par(new=T)      
 chart.TimeSeries(tmp.unitroot.xts.diff,main="",type="h",lwd="4",color="red",xaxis=F,yaxis.right=T,legend.loc="topright",cex.legend=3,ylab="",cex.lab=4,cex.axis=4)
 dev.off()
 cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\" alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)   
 cat("<hr>\n",file=buf.html,append=T) 
}
} 
######################################unitrootパート######################################    
######################################  acf  パート ######################################    
if(exe.acf==1){
bbbb<-4
buf.html<-outputhtml[uuuu,bbbb] 
tmp.acf<-tmp.1[,c(1:2)]
fun.omit(tmp.acf)  
tmp.acf<-tmp.omit
png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,".png",sep="")      
png(file=png.file,width=1400,height=1200) 
par(mar=c(9, 7, 15, 4))
par(cex.main=4,cex.lab=2,cex.axis=2)
if(monthly==1){
 date.f<-format(tmp.acf[1,1],"%Y-%m")
 date.e<-format(tmp.acf[nrow(tmp.acf),1],"%Y-%m")
}else{
 date.f<-format(tmp.acf[1,1],"%Y-%m-%d")
 date.e<-format(tmp.acf[nrow(tmp.acf),1],"%Y-%m-%d")
}        
acf(tmp.acf[,2],acf.lag,main=paste("自己相関係数\n",colnames(tmp.acf)[2],"\n",date.f,"-",date.e),lwd="4")
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
} 
######################################  acf  パート ######################################    
######################################forecastパート###################################### 
if(exe.forecast==1){ 
if(ppp==1){  
bbbb<-5
buf.html<-outputhtml[uuuu,bbbb]  
#future
tmp.forecast<-tmp.1[,c(1:2)] 
fun.omit(tmp.forecast)
tmp.forecast<-tmp.omit  
forecast.interval<-floor(length(tmp.forecast[,2])/10)
png.file<-paste(js.title[[iii]],data.id[bbbb],"future",ppp,count,".png",sep="")    
png(file=png.file,width=1400,height=1200) 
par(mar=c(5, 7, 15, 4))
par(cex.main=4,cex.lab=2,cex.axis=2)
if(monthly==1){
 date.f<-format(tmp.forecast[1,1],"%Y-%m")
 date.e<-format(tmp.forecast[nrow(tmp.forecast),1],"%Y-%m")
}else{
 date.f<-format(tmp.forecast[1,1],"%Y-%m-%d")
 date.e<-format(tmp.forecast[nrow(tmp.forecast),1],"%Y-%m-%d")
}     
result.arima<-auto.arima(tmp.forecast[,2],ic="aic",trace=T,stepwise=T)
result.forecast<-forecast(result.arima,level=c(50,75,95),h=forecast.interval)  
chart.title<-paste("Forecasts from",result.forecast$method,"\n",colnames(tmp.forecast)[2],"\n",date.f,"-",date.e)  
plot(result.forecast,main=chart.title,ylab="",lwd="4")  
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
#test
y.min<-min(tmp.forecast[,2],min(result.forecast$lower[,3]))  
y.max<-max(tmp.forecast[,2],max(result.forecast$upper[,3]))  
png.file<-paste(js.title[[iii]],data.id[bbbb],"test",ppp,count,".png",sep="")    
png(file=png.file,width=1400,height=1200) 
par(mar=c(5, 7, 18, 4))
par(cex.main=4,cex.lab=2,cex.axis=2)
tmp.forecast.test<-tmp.forecast[1:(nrow(tmp.forecast)-forecast.interval),]  
if(monthly==1){
 date.f<-format(tmp.forecast.test[1,1],"%Y-%m")
 date.e<-format(tmp.forecast.test[nrow(tmp.forecast.test),1],"%Y-%m")
}else{
 date.f<-format(tmp.forecast.test[1,1],"%Y-%m-%d")
 date.e<-format(tmp.forecast.test[nrow(tmp.forecast.test),1],"%Y-%m-%d")
}     
result.arima.test<-auto.arima(tmp.forecast.test[,2],ic="aic",trace=T,stepwise=T)       
result.forecast.test<-forecast(result.arima.test,level=c(50,75,95),h=forecast.interval)  
chart.title<-paste("Verification\nForecasts from",result.forecast.test$method,"\n",colnames(tmp.forecast.test)[2],"\n",date.f,"-",date.e)  
plot(result.forecast.test,ylim=c(y.min,y.max),ylab="",main=chart.title,xlab="",lwd="4")   
par(new=T)
plot(tmp.forecast[,2],type="l",col="2", ylim=c(y.min,y.max),ylab="",xlab="",lwd="4")   
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
}
} 
######################################forecastパート######################################    
######################################returnfitting ###################################### 
if(exe.return==1){ 
if(ppp==1){
bbbb<-6
buf.html<-outputhtml[uuuu,bbbb]   
tmp.fitting<-tmp.1[,c(1:2)]
fun.omit(tmp.fitting)  
tmp.fitting<-tmp.omit  
tmp.fitting.return<-data.frame(tmp.fitting[,1][-1],diff(tmp.fitting[,2])/tmp.fitting[,2][-nrow(tmp.fitting)]*100)
fun.omit(tmp.fitting.return)  
tmp.fitting.return<-tmp.omit  
#caution 分母がゼロの場合のエスケープを挟むこと
colnames(tmp.fitting.return)<-c("Date","value")
if(monthly==1){
 date.f<-format(tmp.fitting.return[1,1],"%Y-%m")
 date.e<-format(tmp.fitting.return[nrow(tmp.fitting.return),1],"%Y-%m")
}else{
 date.f<-format(tmp.fitting.return[1,1],"%Y-%m-%d")
 date.e<-format(tmp.fitting.return[nrow(tmp.fitting.return),1],"%Y-%m-%d")
}  
g<-ggplot(tmp.fitting.return,aes(x=value))      
g<-g+geom_histogram(alpha=0.2,colour="blue",binwidth=0.1)
g<-g+theme(plot.title=element_text(size=50))
g<-g+theme(axis.title.x=element_text(size=40),axis.title.y=element_text(size=40)) 
g<-g+theme(axis.text.x=element_text(size=40),axis.text.y=element_text(size=40)) 
g<-g+ggtitle(paste("Returen of ",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e))
g<-g+xlab("Return(%)")+ylab("Count")      
png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,".png",sep="")     
png(file=png.file,width=1400,height=1200) 
plot(g)
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T) 
tmp.data<-na.omit(tmp.fitting.return[,2]) 
png.file<-paste(js.title[[iii]],data.id[bbbb],"qq",ppp,count,".png",sep="")     
png(file=png.file,width=1400,height=1200) 
par(mar=c(5, 5, 14, 2))      
qqnorm(tmp.data,main=paste("Normal Q-Q Plot Return of",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e,"\nShapiro Test:p-value=",shapiro.test(tmp.data)$p.value),cex.main=4,cex.legend=3,cex.lab=2,cex.axis=3)
qqline(tmp.data,col="2",lwd="5") 
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T) 
eeeeeee<-0#一旦中止
if(eeeeeee==1){
 png.file<-paste(js.title[[iii]],data.id[bbbb],"cdf",ppp,count,".png",sep="")     
 png(file=png.file,width=1400,height=1200)
 par(mar=c(5, 5, 14, 2))     
 plot(ecdf(tmp.data),main=paste("Empirical distribution\nReturn of ",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e),cex.main=4,cex.legend=3,cex.lab=2,cex.axis=3)      
 dev.off()
 cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
}  
}
}  
######################################returnfitting ######################################    
######################################  returnrank  ######################################
if(exe.rank==1){
if(ppp==1){
bbbb<-7
buf.html<-outputhtml[uuuu,bbbb]   
tmp.return.rank.table<-tmp.fitting.return
tmp.return.rank.table[,1]<-as.factor(tmp.return.rank.table[,1])      
if(monthly==1){
 tmp.return.rank.table[,1]<-substr(tmp.return.rank.table[,1],1,7)  
}  
return.rank<-order(tmp.return.rank.table[,2])      
tmp.return.rank.table<-tmp.return.rank.table[return.rank,]
tmp.return.rank.table[,1]<-ordered(tmp.return.rank.table[,1],levels=tmp.return.rank.table[,1][1:length(tmp.return.rank.table[,1])])
for(rrrr in 1:2){#3の時系列チャートは一旦中止      
 if(rrrr==1){
  tmp.return.rank.table.plot<-head(tmp.return.rank.table,10)
  rank.title=paste("Top 10 of Return:Plunge\n",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e)
 }else if(rrrr==2){
  tmp.return.rank.table.plot<-tail(tmp.return.rank.table,10)
  rank.title=paste("Top 10 of Return:Jump\n",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e)
 }else{
  tmp.return.rank.table.plot<-tmp.fitting.return
  rank.title=paste("Time Series of Return\n",colnames(tmp.fitting)[2],"\nfrom ",date.f," to ",date.e)
 }  
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,rrrr,".png",sep="")     
 png(file=png.file,width=1400,height=1200)       
 g<-ggplot(tmp.return.rank.table.plot,aes(x=Date,y=value))
 g<-g+geom_bar(stat="identity",position="identity",fill="grey",alpha=0.5,color="black")
 if(rrrr!=3){
  g<-g+coord_flip() #vjust=-0.5
  if(rrrr==1){
   g<-g+geom_text(aes(label=format(tmp.return.rank.table.plot[,2],digits=2, nsmall=2)),hjust=-1,size=15)
  }else{
   g<-g+geom_text(aes(label=format(tmp.return.rank.table.plot[,2],digits=2, nsmall=2)),hjust=1,size=15)
  }
 }
 g<-g+theme(plot.title=element_text(size=55))
 g<-g+theme(axis.title.x=element_text(size=40),axis.title.y=element_text(size=40)) 
 g<-g+theme(axis.text.x=element_text(size=40),axis.text.y=element_text(size=40)) 
 g<-g+ggtitle(rank.title)
 g<-g+ylab("Return(%)")+xlab("Date")
 plot(g)
 dev.off()
 cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T) 
}
}
}  
######################################  returnrank  ###################################### 
######################################  garch       ###################################### 
if(exe.garch==1){
if(ppp==1){ 
bbbb<-8
buf.html<-outputhtml[uuuu,bbbb]     
if(monthly==1){
 fit.ahead=12
}else{
 fit.ahead=90
}  
tmp.garch<-tmp.1[,c(1:2)]
fun.omit(tmp.garch)  
tmp.garch<-tmp.omit  
fun.calc.garch<-function(){
 tmp.garch.result<-try(garchFit(~garch(1,1),data=tmp.garch[,2],trace=F))   
 tmp.garch.result<<-tmp.garch.result
}
either.error<-try(fun.calc.garch(),silent=FALSE)
if(class(either.error)!="try-error"){
 goahead<-1                        
}else{
 goahead<-0                        
}
if(goahead==1){
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,".png",sep="")   
 png(file=png.file,width=1400,height=1200)
 par(mfrow=c(1, 1),ps=40)
 par(mar=c(5, 7, 10, 2))       
 fun.gettitle()  
 predict(tmp.garch.result,n.ahead=fit.ahead,plot=T,nx=nrow(tmp.garch))
 #plot(tmp.garch.result)  
 #0      
 #1# Time Series                                 
 #2# Conditional SD                           
 #3# Series with 2 Conditional SD Superimposed   
 #4# ACF of Observations                      
 #5# ACF of Squared Observations     
 #6# Cross Correlation                        
 #7# Residuals      
 #8# Conditional SDs                          
 #9# Standardized Residuals      
 #10# ACF of Standardized Residuals            
 #11# ACF of Squared Standardized Residuals 
 #12# Cross Correlation between r^2 and r      
 #13# QQ-Plot of Standardized Residuals 
 if(monthly==1){
  date.f<-format(tmp.garch[1,1],"%Y-%m")
  date.e<-format(tmp.garch[nrow(tmp.garch),1],"%Y-%m")
 }else{
  date.f<-format(tmp.garch[1,1],"%Y-%m-%d")
  date.e<-format(tmp.garch[nrow(tmp.garch),1],"%Y-%m-%d")
 }  
 cat(paste("\n<div align=\"center\"><b>",tmp.garch.result@title,"\n",tmp.garch.result@method,"\n",gettitle,"</b></div>"),file=buf.html,append=T)      
 cat(paste("\n<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T) 
 dev.off()
}  
}
}
######################################  garch       ###################################### 
##################################マルコフ転換モデル######################################
if(exe.msm==1){
if(ppp==1){
bbbb<-9
buf.html<-outputhtml[uuuu,bbbb]    
cat("<div align=\"center\"><b>Markov Switching Models\npowered by R package 'MSwM' - msmFit()\n",file=buf.html,append=T)
x<-seq(1:nrow(tmp.1))    
tmp.msm<-data.frame(x,y=tmp.1[,2])
tmp.msm.lm<-lm(y~x,tmp.msm)
result.msm<-msmFit(tmp.msm.lm,k=2,p=0,sw=rep(T,length(tmp.msm)+1))# k(example bull or bear)   
cat(paste("\n<div align=\"center\"><b>",gettitle,"</b></div>"),file=buf.html,append=T)      
for(qqqq in 2:(length(tmp.msm)+1)){#1は一旦中止
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,qqqq,".png",sep="")
 png(file=png.file,width=1400,height=1200)
 par(ps=40)
 par(mar=c(9, 7, 15, 4))
 plotProb(result.msm,which=qqqq)
 dev.off() 
 cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
}
}
}
##################################マルコフ転換モデル###################################### 
############### Self-Exciting Threshold AutoRegressive models ############################  
if(exe.setar==1){
if(ppp==1){
bbbb<-10
buf.html<-outputhtml[uuuu,bbbb]  
fun.calc.setar<-function(){
 result.setar<-setar(tmp.1[,2],mL=2,mM=2,mH=2,nthresh=2,thDelay=0)#ARモデルの次数は都度検討すること
 result.setar<<-result.setar
}
either.error<-try(fun.calc.setar(),silent=FALSE)
if(class(either.error)!="try-error"){
 goahead<-1                        
}else{
 goahead<-0                        
}  
if(goahead==1){  
 cat("<div align=\"center\"><b>Self-Exciting Threshold AutoRegressive models\npowered by R package 'tsDyn' - setar()<b></div>\n",file=buf.html,append=T)
 cat("Caution:\nThe time series data may have unit roots.\n",file=buf.html,append=T)
 cat(paste("\n<div align=\"center\"><b>",gettitle,"</b></div>"),file=buf.html,append=T)      
 png.file<-paste(js.title[[iii]],data.id[bbbb],ppp,count,".png",sep="")
 png(file=png.file,width=1400,height=1200)    
 par(ps=30)
 par(mar=c(9, 7, 15, 4))
 plot(result.setar,ask=FALSE)
 dev.off()
 cat("Proportion of points in\n",file=buf.html,append=T)
 cat(paste("low regime:",round(result.setar$model.specific$RegProp[1]*100,digits=2),"%\nMiddle regime:",round(result.setar$model.specific$RegProp[2]*100,digits=2),"%\nHigh regime:",round(result.setar$model.specific$RegProp[3]*100,digits=2),"%\nth1:",result.setar$coefficients[10],"\nth2:",result.setar$coefficients[11],"\n",sep=""),file=buf.html,append=T)     
   cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=buf.html,append=T)
}
}
}  
############### Self-Exciting Threshold AutoRegressive models ############################  
    }#条件分岐001
   }
  }
 }
}
```

```{r}
#MULTIVARIATEDATAANALYSIS
setwd(pathOutput)
######################################引数設定パート######################################    
ttt.range<-c(1:2)
analysis.id<-"MULTIVARIATEDATAANALYSIS"
title.no<-3
js.title<-c("MANETARYBASEANDUNEMPLOYMENTRATEJAPAN","MANETARYBASEANDUNEMPLOYMENTRATEUSA","MANETARYBASEANDUSDJPY")
priod.y<-100 #year
explanatory<-3 #column
objective<-2 #column
#multianalysis.html<-paste(js.title[title.no],id,".html",sep="")
multianalysis.html<-paste(js.title[title.no],".html",sep="")
cat("",file=multianalysis.html,append=F)
#first.date<-c("2001-4-26","1946-6-1","1993-1-20","1987-8-11")
if(ttt.range[1]==1){
  ttt.diff<-3
}else{
  ttt.diff<-1
}
ppp<-1
chk<-0
iii<-1
obj<-c(1)
######################################引数設定パート###################################### 
dataset[[obj[iii]]]<-tail(na.omit(all.data[[1]]),priod.y*12)
fun.withkeyposition()
tmp.1<-tmp.0[,c(1,2,3,5)]
for(uuu in 1:length(unique(tmp.1[,4]))){
objectDataset<-subset(tmp.1,tmp.1[,4]==unique(tmp.1[,4])[uuu])
date.f<-format(objectDataset[1,1],"%Y-%m")
date.e<-format(objectDataset[nrow(objectDataset),1],"%Y-%m")
graph.title1<-colnames(objectDataset)[explanatory]
colnames(objectDataset)[explanatory]<-graph.title1
graph.title2<-colnames(objectDataset)[objective]
colnames(objectDataset)[objective]<-graph.title2
keyposition.id<-paste(colnames(objectDataset)[4],":",unique(tmp.1[,4])[uuu],sep="")  
######################################cointegパート ######################################    
cat("<div align=\"center\"><b>Co-integration test\n\n",file=multianalysis.html,append=T)
cat("Null hypothesis:Not cointegrated.\n",file=multianalysis.html,append=T)
cat("powered by Package 'tseries' - po.test(),adf.test()\n\n",file=multianalysis.html,append=T)
cat("Period:",date.f,"-",date.e,"\n",file=multianalysis.html,append=T)
cat(keyposition.id,"</b></div>\n",file=multianalysis.html,append=T)
#説明変数パート
cat("",file=multianalysis.html,append=T)
cat(colnames(objectDataset)[explanatory],"\n",file=multianalysis.html,append=T)
value<-objectDataset[,explanatory]
tmp.unitroot.result<-capture.output(adf.test(value))
tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)
write(tmp.unitroot.result,multianalysis.html,append=T)
tmp.unitroot.result<-capture.output(adf.test(diff(value)))
tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)
write(tmp.unitroot.result,multianalysis.html,append=T)
#応答変数パート
cat("<hr>",file=multianalysis.html,append=T)
cat(colnames(objectDataset)[objective],"\n",file=multianalysis.html,append=T)
value<-objectDataset[,objective]
tmp.unitroot.result<-capture.output(adf.test(value))
tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)
write(tmp.unitroot.result,multianalysis.html,append=T)
tmp.unitroot.result<-capture.output(adf.test(diff(value)))
tmp.unitroot.result<-gsub(",\\s","\n",tmp.unitroot.result, perl=T)
write(tmp.unitroot.result,multianalysis.html,append=T)
#共和分検定パート
cat("<hr>",file=multianalysis.html,append=T)
MULTIVARIATE<-objectDataset[,c(objective,explanatory)]
tmp.cointeg<-capture.output(po.test(MULTIVARIATE))
tmp.cointeg<-gsub(",\\s","\n",tmp.cointeg, perl=T)
write(tmp.cointeg,multianalysis.html,append=T)
#output png
##cointeg
#png.file<-paste(js.title[title.no],"cointeg",id,".png",sep="")
png.file<-paste(js.title[title.no],"cointeg",uuu,".png",sep="")
png(file=png.file,width=1400,height=1200) 
par(mar=c(7, 7, 14, 2))
par(ps=40)
ccf(diff(objectDataset[,objective]),diff(objectDataset[,explanatory]),24,main=paste("相互相関係数(共に一次階差)\n",colnames(objectDataset)[explanatory],"×",colnames(objectDataset)[objective],"\n",keyposition.id),lwd="4")
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=multianalysis.html,append=T)
##chart
###level
png.file<-paste(js.title[title.no],"levelchart",uuu,".png",sep="")
png(file=png.file,width=1400,height=1200)
par(mar=c(5, 5, 14, 2))
objectDataset.xts<-as.xts(objectDataset[,c(explanatory,objective)],order.by=as.Date(objectDataset[,1]))
maintitle.first<-format(first(index(objectDataset.xts)),"%Y-%m")
maintitle.last<-format(last(index(objectDataset.xts)),"%Y-%m")
chart.TimeSeries(objectDataset.xts[,1],main=paste("Level\n",maintitle.first,"-",maintitle.last,"\n",keyposition.id),yaxis.right=F,type="l",lwd="4",legend.loc="bottomleft",color="blue",cex.main=5,cex.legend=3,cex.lab=2,cex.axis=3,ylab="") 
par(new=T)      
chart.TimeSeries(objectDataset.xts[,2],main="",type="l",lwd="4",color="red",xaxis=F,yaxis.right=T,legend.loc="topright",cex.legend=3,ylab="",cex.axis=3)
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=multianalysis.html,append=T)
###1stdiff
png.file<-paste(js.title[title.no],"1stdiffchart",uuu,".png",sep="")
png(file=png.file,width=1400,height=1200)
par(mar=c(5, 5, 14, 2))
objectDataset.xts.diff<-diff(objectDataset.xts)
maintitle.first<-format(first(index(objectDataset.xts.diff)),"%Y-%m")
maintitle.last<-format(last(index(objectDataset.xts.diff)),"%Y-%m")
chart.TimeSeries(objectDataset.xts.diff[,1],main=paste("1stDiff\n",maintitle.first,"-",maintitle.last,"\n",keyposition.id),yaxis.right=F,type="h",lwd="4",legend.loc="bottomleft",color="blue",cex.main=5,cex.legend=3,cex.lab=2,cex.axis=3,ylab="") 
par(new=T)      
chart.TimeSeries(objectDataset.xts.diff[,2],main="",type="h",lwd="4",color="red",xaxis=F,yaxis.right=T,legend.loc="topright",cex.legend=3,ylab="",cex.axis=3)
dev.off()
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n",sep=""),file=multianalysis.html,append=T)
######################################cointegパート ######################################    
######################################  var  パート ######################################    
png.file<-paste(js.title[title.no],"impulse",uuu,".png",sep="")
png(file=png.file,width=1400,height=1200)
par(ps=25)
tmp.var<-objectDataset[,2:3]
orig.colnames<-colnames(tmp.var)
tmp.var[,1]<-tmp.var[,1]/mean(tmp.var[,1])
tmp.var[,2]<-tmp.var[,2]/mean(tmp.var[,2])
colnames(tmp.var)<-c("impulse","response")
var.lag<-floor(nrow(tmp.var)/2)  
tmp.var.result<-VAR(tmp.var,p=VARselect(tmp.var,lag.max=var.lag)$selection[1])#AIC
tmp.var.irf<-irf(tmp.var.result,impulse="impulse",response=c("response"),boot=TRUE,n.ahead=24,ci=0.95)
plot(tmp.var.irf,ask=FALSE,lwd=4)
dev.off()
cat(paste("<hr>\n<div align=\"center\">\n<b>Orthogonal Impulse Response\nfrom",orig.colnames[1],"(Impulse)\nto",orig.colnames[2],"\n",keyposition.id,"(Response)\n各系列はその平均値で正規化しています</b>\npowered by R package 'vars' - VAR(),irf()</div>"),file=multianalysis.html,append=T)
cat(paste("<img src=\"http://archive.am-consulting.co.jp/",png.file,add.ver,"\"", " alt=\"\" width=\"100%\">\n\n<hr>\n",sep=""),file=multianalysis.html,append=T)
######################################  var  パート ######################################    
}
#javascript part    
js.file.name<-paste(js.title[title.no],analysis.id,".js",sep="")
data.id<-analysis.id
cat("\n\n$(function() {",file=js.file.name,append=F)
cat(paste("\n$.get('http://archive.am-consulting.co.jp/",multianalysis.html,add.ver,"', function(data) {",sep=""),file=js.file.name,append=T)
cat(paste("\n$('#",data.id,"').html('<pre>' + data + '</pre>');",sep=""),file=js.file.name,append=T)
cat("\n});",file=js.file.name,append=T)
cat("\n});\n\n",file=js.file.name,append=T)
```