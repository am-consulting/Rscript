```{r}
requiredPackageList<-c("ggplot2","lubridate","scales","maps","maptools","RColorBrewer","fields","rworldmap","classInt","plotrix","HH","reshape","gridExtra","XLConnect")
colnames(installed.packages())
notInstalledPackages<-requiredPackageList[!(requiredPackageList %in% installed.packages()[,"Package"])] #apply logical vector to requiredPackageList
if(length(notInstalledPackages)!=0){print(notInstalledPackages);install.packages(notInstalledPackages)}
lapply(requiredPackageList,require,character.only=T)
#Reference 
#http://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them
#http://stackoverflow.com/questions/8175912/load-multiple-packages-at-once
username<-Sys.info()['user']
pathOutput<-paste("C:/Users/",username,"/Desktop/charts/",sep="")
pathJmap<<-paste("C:/Users/",username,"/Desktop/jpn/",sep="")
pathWmap<<-paste("C:/Users/",username,"/Desktop/ne_50m_admin_0_countries/",sep="")
SD<-Sys.Date()
creationDate<-paste("作成日:",year(SD),"-",month(SD),"-",day(SD),sep="")  
setwd(pathOutput)
windowsFonts(Meiryo=windowsFont("Meiryo"))
fun.readData<-function(){
  dataset<-read.table("clipboard",header=TRUE,sep="\t",stringsAsFactor=F,na.strings=c("-","－","      ","***"),check.names=FALSE)
  #ファイル名禁則文字対策
  #禁則文字(ファイル名,フォルダー名)
  #半角記号の \　/　:　*　?　"　<　>　|
  colnames(dataset)<-gsub("/","／",colnames(dataset))
  #ファイル名禁則文字対策
  dataset<<-dataset
  print(head(dataset))
  print(tail(dataset))
}
fun.round<-function(buf){
  return.buf<<-round(buf/10^floor(log10(buf)),1)*10^floor(log10(buf))
}  
```

```{r}
#PMパート
successiveCabinets<-list()  
funSuccessiveCabinets<-function(){
successiveCabinets[[1]]<-c(
"1937-6-4","近衛文麿",
"1939-1-5","平沼騏一郎",
"1939-8-30","阿部信行",
"1940-1-16","米内光政",
"1940-7-22","近衛文麿(2次)",
"1941-10-18","東條英機",
"1944-7-22","小磯國昭",
"1945-4-7","鈴木貫太郎",
"1945-8-17","東久邇宮稔彦王",
"1945-10-9","幣原喜重郎",
"1946-5-22","吉田茂",
"1947-5-24","片山哲",
"1948-3-10","芦田均",
"1948-10-15","吉田茂(2-5次)",
"1954-12-10","鳩山一郎",
"1956-12-23","石橋湛山",
"1957-2-25","岸信介",
"1960-7-19","池田勇人",
"1964-11-9","佐藤栄作",
"1972-7-7","田中角栄",
"1974-12-9","三木武夫",
"1976-12-24","福田赳夫",
"1978-12-7","大平正芳",
"1980-7-17","鈴木善幸",
"1982-11-27","中曽根康弘",
"1987-11-6","竹下登",
"1989-6-3","宇野宗佑",
"1989-8-10","海部俊樹",
"1991-11-5","宮沢喜一",
"1993-8-9","細川護熙",
"1994-4-28","羽田孜",
"1994-6-30","村山富市",
"1996-1-11","橋本龍太郎",
"1998-7-30","小渕恵三",
"2000-4-5","森喜朗",
"2001-4-26","小泉純一郎",
"2006-9-26","安倍晋三(1次)",
"2007-9-26","福田康夫",
"2008-9-24","麻生太郎",
"2009-9-16","鳩山由紀夫",
"2010-6-8","菅直人",
"2011-9-2","野田佳彦",
"2012-12-26","安倍晋三(2次-)"
)
successiveCabinets[[2]]<-c(
"1937-7-27","結城豊太郎",
"1944-3-18","渋沢敬三",
"1945-10-9","新木榮吉",
"1946-6-1","一万田尚登",
"1954-12-11","新木榮吉(2次)",
"1956-11-30","山際正道",
"1964-12-17","宇佐美洵",
"1969-12-17","佐々木直",
"1974-12-17","森永貞一郎",
"1979-12-17","前川春雄",
"1984-12-17","澄田智",
"1989-12-17","三重野康",
"1994-12-17","松下康雄",
"1998-3-20","速水優",
"2003-3-20","福井俊彦",
"2008-4-9","白川方明",
"2013-3-20","黒田東彦"
)
successiveCabinets[[3]]<-c(
"1933-3-4","Franklin Delano Roosevelt",  
"1945-4-12","Harry S. Truman",
"1953-1-20","Dwight David Eisenhower",
"1961-1-20","John Fitzgerald Kennedy",
"1963-11-22","Lyndon Baines Johnson",
"1969-1-20","Richard Milhouse Nixon",
"1974-8-9","Gerald Rudolph Ford Jr.",
"1977-1-20","James Earl Carter",
"1981-1-20","Ronald Wilson Reagan",
"1989-1-20","George H.W Bush",
"1993-1-20","Bill Clinton",
"2001-1-20","George W. Bush",
"2009-1-20","Barack Obama"
)
successiveCabinets[[4]]<-c(
"1934-11-15","Marriner Eccles",
"1948-4-15","Thomas B. McCabe",
"1951-4-2","William M. Martin",
"1970-2-1","Arthur F.Burns",
"1978-3-8","G.William Miller",
"1987-8-11","Alan Greenspan",
"2006-2-1","Ben S.Bernanke",
"2014-2-1","Janet Yellen"
)
for(ttt in 1:length(successiveCabinets)){
  tmp<-successiveCabinets[[ttt]]
  inaugural.date<-as.Date(tmp[seq(1,length(tmp),by=2)])
  resignation.date<-c((inaugural.date-1)[-1],Sys.Date()+31) # 最後のSys.Date()+31は現職用
  Name<-tmp[seq(2,length(tmp),by=2)]
  successiveCabinets[[ttt]]<-data.frame(inaugural.date,resignation.date,Name)
  successiveCabinets[[ttt]][,3]<-ordered(successiveCabinets[[ttt]][,3],levels=successiveCabinets[[ttt]][,3][1:nrow(successiveCabinets[[ttt]])])
  order(successiveCabinets[[ttt]][,3])
  successiveCabinets[[ttt]]<<-successiveCabinets[[ttt]] #caution
}
}  
funSuccessiveCabinets() 
for(ttt in 1:length(successiveCabinets)){
print(head(successiveCabinets[[ttt]]))
print(tail(successiveCabinets[[ttt]]))
}  
#PMパート
```

```{r}
#IMF Primary Commodity Prices
path<-paste("C:/Users/",username,"/Desktop/downloadExcelData/",sep="")
setwd(path)
url<-"http://www.imf.org/external/np/res/commod/"
filename<-"External_Data.xls"
download.file(paste(url,filename,sep=""),filename,mode="wb")
tmp<-readWorksheetFromFile(filename,1,header=F,check.names=F)
dataset<-tmp[-(1:4),]
FUN.1<-function(x){as.numeric(x)}
dataset<-data.frame(dataset[,1],apply(dataset[,-1],2,FUN.1))
colnames(dataset)<-tmp[3,]
dataset[,1]<-as.Date(paste(substr(dataset[,1],1,4),"-",substr(dataset[,1],6,7),"-1",sep=""))
colnames(dataset)[1]<-"Date"
tail(dataset,1)
mainTitle<-"IMF Primary Commodity Prices - "
dataSource<-"\nData Source:International Monetary Fund"
dateType<-2 #1:日次 2:月次 3:character(第*週他)
chartType<-1 #1:line , 2:bar
fitType<-2 #1:lm , 2:loess , 3:none
imfPCP<-1
needWeekly<-0
consumptionTax<-0
#IMF Primary Commodity Prices
```

```{r}
fun.readData()
gitURL<-list()
imfPCP<-0
inverse<-2 #逆サイクル:1,非逆サイクル:2
consumptionTax<-1
needWeekly<-1
grobTableTail<-13
csvTail<-100000
needCSV<-1
dateType<-2 #1:日次 2:月次 3:character(第*週他) 4:年次
chartType<-1 #1:line , 2:bar
fitType<-2 #1:lm , 2:loess , 3:none
autoChartType<-0
tailNumber<-10000000000
annotation<-1 # need:1,no need:2
perpbr<-0
outputFolder<-2 #1:R_Data_Write,2:charts,3:weeklyResult
weeklyText<-"weeklyResult.html"  
htmlFile<-"linktoImage.html"  
onlyLink<-"onlyLink.html"  
#setwd(paste("C:/Users/",username,"/Desktop/weeklyResult/",sep=""))
#cat("",file=weeklyText,append=F)
#cat("",file=htmlFile,append=F)
# =YEAR(B16)&"年"&MONTH(B16)&"月第"&WEEKNUM(B16,1)-WEEKNUM(DATE(YEAR(B16),MONTH(B16),1),1)+1&"週"
#↓規模別・業種別PER・PBR（連結・単体）一覧
# =TEXT(ROW()-12,"00")&SUBSTITUTE(SUBSTITUTE(SUBSTITUTE(SUBSTITUTE(MID($A13,3,LEN($A13)),CHAR(32),""),CHAR(160),""),"・","."),"、",".")
# =IF(H13="-",-9999999,H13)
#↑規模別・業種別PER・PBR（連結・単体）一覧
```

```{r}
switch(outputFolder,
pathOutput<-paste("C:/Users/",username,"/Desktop/R_Data_Write/",sep=""),
pathOutput<-paste("C:/Users/",username,"/Desktop/charts/",sep=""),
pathOutput<-paste("C:/Users/",username,"/Desktop/weeklyResult/",sep=""),
dammy  
)  
setwd(pathOutput)
```

```{r}
cat("",file=htmlFile,append=F)
cat("",file=onlyLink,append=F)
cat("",file=weeklyText,append=F)
```

```{r}
cat("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n",file=htmlFile,append=T)
cat("<style>select {font-family: Meiryo;}</style>\n",file=htmlFile,append=T)
cat("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n",file=onlyLink,append=T)
cat("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n",file=weeklyText,append=T)
```

```{r}
########################################## time series ##########################################
if(colnames(dataset)[1]=="Date"){
  dataset[,1]<-as.Date(dataset[,1])
}
setwd(pathOutput)
if(imfPCP==0){
mainTitle<-"景気動向指数個別一致系列 - "
mainTitle<-"日本の外貨準備等状況 - "
mainTitle<-"日本の消費動向調査 - "
mainTitle<-"日本の建設工事受注動態統計調査(単位:兆円) - "
mainTitle<-"日本の機械受注統計調査(機械別受注額、原系列、億円) - "
mainTitle<-"日本の国内総生産 - "
mainTitle<-"日本の建設総合統計 - "
mainTitle<-"日本の企業向けサービス価格指数 - "
mainTitle<-"財務省貿易統計(億円) - "
mainTitle<-"財務省貿易統計 輸出 主要商品別(億円) - "
mainTitle<-"財務省貿易統計 輸入 主要商品別(億円) - "
mainTitle<-"日本の労働力調査 - "
mainTitle<-"有効求人倍率 - "
mainTitle<-"日本の労働力調査 - 役員を除く雇用形態別雇用者(万人)"
mainTitle<-"住宅着工統計 - "
mainTitle<-"建築着工統計 - "
mainTitle<-"設備投資(当期末新設固定資産合計,百万円)-全規模 - "
mainTitle<-"日本のマネタリーベース(兆円,%) - "
mainTitle<-"利益剰余金(全産業、全規模、兆円) - "
mainTitle<-"日本の建設労働需給調査(%) - "
mainTitle<-"日本の法人税課税状況 - "
mainTitle<-"日本の申告所得税額 - "
mainTitle<-"日本の源泉所得税課税状況 - "
mainTitle<-"日本の出生数及び合計特殊出生率 - "
mainTitle<-"預金・貸出合計 - "
mainTitle<-"景気動向指数"
mainTitle<-"日本の国際収支 - "
mainTitle<-"日本の景気ウォッチャー調査 - "
mainTitle<-"日本のマネーストック - "
mainTitle<-"日本の国内企業物価指数 - "
mainTitle<-"日本の預金動向 - "
mainTitle<-"対外及び対内証券投資売買契約等の状況(億円) - "
mainTitle<-"資金循環統計 - "
mainTitle<-"第3次産業活動指数 - "
mainTitle<-"鉱工業指数 - "
mainTitle<-"建設総合統計 - "
mainTitle<-"日本の特定サービス産業動態売上高指数 - "
mainTitle<-"株式平均利回り - "
mainTitle<-"週間石油在庫統計 - "
mainTitle<-"日本の企業向けサービス価格指数 - "
mainTitle<-"日本の消費者物価指数 - "
mainTitle<-"全産業活動指数 - "
#dataSource<-"\nData Source:Hellenic Statistical Authority"
#dataSource<-"\nData Source:International Monetary Fund"
dataSource<-"\nData Source:厚生労働省"
dataSource<-"\nData Source:国税庁"
dataSource<-"\nData Source:内閣府"
dataSource<-"\nData Source:内閣府"
dataSource<-"\nData Source:財務省"
dataSource<-"\nData Source:国土交通省"
dataSource<-"\nData Source:株式会社日本取引所グループ"
dataSource<-"\nData Source:U.S. Energy Information Administration"
dataSource<-"\nData Source:日本銀行"
dataSource<-"\nData Source:総務省"
dataSource<-"\nData Source:経済産業省"
}  
if(needWeekly==1){
#outputFolder<-3 #3:weeklyResult
}
if(mainTitle=="週間石油在庫統計 - " | mainTitle=="対外及び対内証券投資売買契約等の状況(億円) - "){
  outputFolder<-2 #1:R_Data_Write,2:charts
  autoChartType<-1
}  
switch(outputFolder,
pathOutput<-paste("C:/Users/",username,"/Desktop/R_Data_Write/",sep=""),
pathOutput<-paste("C:/Users/",username,"/Desktop/charts/",sep=""),
pathOutput<-paste("C:/Users/",username,"/Desktop/weeklyResult/",sep=""),
dammy  
)  
setwd(pathOutput)
#####################
if(perpbr==1){
  dataset[dataset==-9999999]<-NA  
  dateType<-3 #1:日次 2:月次 3:character(第*週他)
  chartType<-2 #1:line , 2:bar
  fitType<-3 #1:lm , 2:loess , 3:none
  mainTitle<-"業種別PER･PBR 連結市場一部 2015/7月末"
  dataSource<-"\nData Source:株式会社東京証券取引所"
  annotation<-2 # need:1,no need:2
}  
switch(dateType,
  dateFormat<-"%Y/%m/%d",
  dateFormat<-"%Y/%m",
  dateFormat<-"dammy",
  dateFormat<-"%Y"
)  
colorList<-c("blue","red")
#row title
#colnames(dataset)[-1]<-paste(mainTitle,colnames(dataset)[-1],sep="")
#row title
for(ccc in 2:ncol(dataset)){
#チャートタイプ選択パート
if(autoChartType==0){
if(nrow(subset(dataset,dataset[,2]<0))==0 | nrow(subset(dataset,dataset[,2]>0))==0){chartType<-1}else{chartType<-2} 
#if(regexpr("比",colnames(dataset)[ccc])!=-1){chartType<-2}else{chartType<-1}  
}
if(chartType==2){fitType<-3}  
#チャートタイプ選択パート
setwd(pathOutput)
buf.dataset<-tail(na.omit(dataset[,c(1,ccc)]),tailNumber)
if(mainTitle=="週間石油在庫統計 - "){  
  tailNumber<-60
  buf.dataset<-tail(na.omit(dataset[,c(1,ccc)]),tailNumber)
  buf.dataset<-data.frame(buf.dataset[-1,1],diff(buf.dataset[,2]))
  colnames(buf.dataset)<-colnames(dataset[,c(1,ccc)])
  colnames(buf.dataset)[2]<-paste("前週差_",colnames(buf.dataset)[2],sep="")
  dateType<-1 #1:日次 2:月次 3:character(第*週他)
  dateFormat<-"%Y/%m/%d"
  chartType<-2 #1:line , 2:bar
  fitType<-3 #1:lm , 2:loess , 3:none
  dataSource<-"\nData Source:U.S. Energy Information Administration"
  consumptionTax<-0
  needCSV<-1
  needWeekly<-0
}
if(mainTitle=="対外及び対内証券投資売買契約等の状況(億円) - "){  
  tailNumber<-60
  buf.dataset<-tail(na.omit(dataset[,c(1,ccc)]),tailNumber)
  dateType<-3 #1:日次 2:月次 3:character(第*週他)
  dateFormat<-"%Y/%m/%d"
  chartType<-2 #1:line , 2:bar
  fitType<-3 #1:lm , 2:loess , 3:none
  dataSource<-"\nData Source:財務省"
  grobTableTail<-13
  consumptionTax<-0
  needCSV<-1
  needWeekly<-0
}
if(colnames(dataset)[1]=="Date"){
  buf.dataset[,1]<-as.Date(buf.dataset[,1])
}else{
  if(perpbr==1){
    buf.dataset[,1]<-ordered(buf.dataset[,1],levels=buf.dataset[,1][length(buf.dataset[,1]):1])
  }else{  
    buf.dataset[,1]<-ordered(buf.dataset[,1],levels=buf.dataset[,1][1:length(buf.dataset[,1])])
  }
  colnames(buf.dataset)[1]<-"Date"
}
melt.dataset<-melt(buf.dataset,id=colnames(buf.dataset)[1])#系列が一つでも強制的にmelt
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste(addVer,".png",sep="")
png(file=png.file,width=1920,height=1080)
switch(chartType,  
  g<-ggplot(data=melt.dataset,aes(x=Date,y=value,color=variable))+geom_line(size=2),
  g<-ggplot(data=melt.dataset,aes(x=Date,y=value,fill=variable))+geom_bar(stat="identity",position="identity",alpha=0.5)
)  
g<-g+scale_y_continuous(labels=comma)
switch(fitType,
  g<-g+geom_smooth(data=melt.dataset,aes(x=Date,y=value),method=lm,lwd=2),
  g<-g+geom_smooth(data=melt.dataset,aes(x=Date,y=value,group=1),method=loess,lwd=2,color="red"),
  g<-g
)
g<-g+scale_color_manual(values=colorList) 
g<-g+scale_fill_manual(values=colorList) 
g<-g+theme(plot.title=element_text(size=40,family="Meiryo"))
g<-g+theme(axis.title.x=element_text(size=30)) 
g<-g+theme(axis.title.y=element_text(size=30)) 
g<-g+theme(axis.text.y=element_text(size=40,angle=90)) 
g<-g+theme(legend.text=element_text(colour="black",size=30,face="plain",family="Meiryo"))   
g<-g+theme(legend.title=element_text(colour="white",size=0,face="bold"))   
g<-g+theme(legend.position="top")          
if(dateType!=3){#Date
  g<-g+theme(axis.text.x=element_text(size=40,angle=0,hjust=0.5,vjust=0.5)) 
  g<-g+ggtitle(paste(
    mainTitle,
    "対象期間:",
    format(head(buf.dataset[,1],1),dateFormat),
    "-",
    format(tail(buf.dataset[,1],1),dateFormat),
    dataSource,
    ". Max/Minの対象は",format(na.omit(dataset[,c(1,ccc)])[1,1],dateFormat),"以降"
    )
  )
  g<-g+scale_x_date(labels=date_format(dateFormat))
  xL1<-as.numeric(buf.dataset[10,1])
  xR1<-as.numeric(buf.dataset[floor(nrow(buf.dataset)/2),1])
  xL2<-as.numeric(buf.dataset[floor(nrow(buf.dataset)/2),1])
  xR2<-as.numeric(buf.dataset[floor(nrow(buf.dataset)),1])
}else{#Non-Date
  g<-g+theme(axis.text.x=element_text(size=30,angle=90,hjust=0.5,vjust=0.5)) 
  g<-g+ggtitle(paste(mainTitle,"対象期間:",head(buf.dataset[,1],1),"-",tail(buf.dataset[,1],1),dataSource,
    ". Max/Minの対象は",na.omit(dataset[,c(1,ccc)])[1,1],"以降"))
  xL1<-1
  xR1<-floor(tailNumber/2)
  xL2<-floor(tailNumber/2)
  xR2<-tailNumber
}  
g<-g+xlab("")
g<-g+ylab("")
#消費税パート
if(consumptionTax==1){
value.y<-(max(buf.dataset[,2])+min(buf.dataset[,2]))/2
#1989年4月消費税  
if(dateType!=4){taxDate1<-"1989-04-01"}else{taxDate1<-"1989-01-01"}  
if(buf.dataset[1,1]<=as.Date(taxDate1)){
  g<-g+geom_vline(xintercept = as.numeric(as.Date(taxDate1)),linetype=1,colour="#d2691e",size=2)
  g<-g+geom_text(aes(x=as.Date(taxDate1), y=value.y*0.975, label="1989年4月\n消費税導入\n(3%)"), size=8,family="Meiryo",colour="black") 
}
#1989年4月消費税  
#1997年4月消費税  
if(dateType!=4){taxDate2<-"1997-04-01"}else{taxDate2<-"1997-01-01"}  
if(buf.dataset[1,1]<=as.Date(taxDate2)){
  g<-g+geom_vline(xintercept = as.numeric(as.Date(taxDate2)),linetype=1,colour="#d2691e",size=2)
  g<-g+geom_text(aes(x=as.Date(taxDate2), y=value.y*0.975, label="1997年4月\n消費税導入\n(3%→5%)"), size=8,family="Meiryo",colour="black") 
}
#1997年4月消費税  
#2014年4月消費税  
if(dateType!=4){taxDate3<-"2014-04-01"}else{taxDate3<-"2014-01-01"}  
if(buf.dataset[1,1]<=as.Date(taxDate3) & tail(buf.dataset[,1],1)>=as.Date(taxDate3)){
  g<-g+geom_vline(xintercept = as.numeric(as.Date(taxDate3)),linetype=1,colour="#d2691e",size=2)
  g<-g+geom_text(aes(x=as.Date(taxDate3), y=value.y*0.975, label="2014年4月\n消費税導入\n(5%→8%)"), size=8,family="Meiryo",colour="black") 
}
#2014年4月消費税  
#第二次安倍政権発足  
if(dateType!=4){taxDate4<-"2013-01-01"}else{taxDate4<-"2013-01-01"}  
if(buf.dataset[1,1]<=as.Date(taxDate4) & tail(buf.dataset[,1],1)>=as.Date(taxDate4)){
  g<-g+geom_vline(xintercept = as.numeric(as.Date(taxDate4)),linetype=1,colour="#DC143C",size=2)
  g<-g+geom_text(aes(x=as.Date(taxDate4), y=value.y*1.0, label="2013年1月\n(2012/12/26)\n第二次安倍政権\n発足"), size=8,family="Meiryo",colour="black") 
}
#第二次安倍政権発足  
#民主党政権発足  
if(dateType!=4){taxDate5<-"2009-09-01"}else{taxDate5<-"2009-01-01"}  
if(buf.dataset[1,1]<=as.Date(taxDate5)){
  g<-g+geom_vline(xintercept = as.numeric(as.Date(taxDate5)),linetype=1,colour="#DC143C",size=2)
  g<-g+geom_text(aes(x=as.Date(taxDate5), y=value.y*1.0, label="2009年9月\n(2009/9/16)\n民主党政権\n発足"), size=8,family="Meiryo",colour="black") 
}
#民主党政権発足  
}  
#消費税パート  
#g<-g+geom_text(aes(x=tail(buf.dataset[,1],1),y=as.numeric(tail(buf.dataset[,-1],1)),label=paste(format(tail(buf.dataset[,1],1),dateFormat),":",as.numeric(tail(buf.dataset[,-1],1)))),size=10,hjust=1)
grobTable<-na.omit(dataset[,c(1,ccc)])
if(mainTitle=="週間石油在庫統計 - "){  
  grobTable<-data.frame(grobTable[-1,1],diff(grobTable[,2]))
}
colnames(grobTable)<-c("Date","Value")  
if(dateType!=3){
  grobTable[,1]<-format(as.Date(grobTable[,1]),dateFormat)
}  
#time series  
if(annotation==1){  
g<-g+annotation_custom(
  tableGrob(
    tail(grobTable,grobTableTail),
    separator="black",
    show.rownames=F,
    h.odd.alpha=0.5,
    h.even.alpha=0.5,
    v.odd.alpha=0.5,
    v.even.alpha=0.5,
    gpar.coretext=gpar(col="black",cex=2.5),
    gpar.coltext=gpar(col="black",cex=2.5,fontfamily="Meiryo"),
    gpar.rowtext=gpar(col="black",cex=2.5,fontfamily="Meiryo")
  ),
  xmin=xL1,
  xmax=xR1,
  ymin=min(na.omit(buf.dataset)[,2]),
  ymax=max(na.omit(buf.dataset)[,2])
)
#max and min  
noteTable<-rbind(
  data.frame(grobTable[which.max(grobTable[,2]),],Note="Max"),  
  data.frame(grobTable[which.min(grobTable[,2]),],Note="Min")  
)  
g<-g+annotation_custom(
  tableGrob(
    noteTable,
    separator="black",
    show.rownames=F,
    h.odd.alpha=0.5,
    h.even.alpha=0.5,
    v.odd.alpha=0.5,
    v.even.alpha=0.5,
    gpar.coretext=gpar(col="black",cex=2.5),
    gpar.coltext=gpar(col="black",cex=2.5,fontfamily="Meiryo"),
    gpar.rowtext=gpar(col="black",cex=2.5,fontfamily="Meiryo")
  ),
  xmin=xL2,
  xmax=xR2,
  ymin=(max(na.omit(buf.dataset)[,2])+min(na.omit(buf.dataset)[,2]))/2,
  ymax=max(na.omit(buf.dataset)[,2])
)
}  
if(perpbr==1){  
  g<-g+ggtitle(paste(mainTitle,dataSource))
  g<-g+geom_text(data=melt.dataset,aes(x=Date,y=value,label=value),size=12)
  g<-g+coord_flip()
  g<-g+theme(axis.text.x=element_text(size=30,angle=0,hjust=1,vjust=0.5))  
  g<-g+theme(axis.text.y=element_text(size=30,angle=0,hjust=1,vjust=0.5))  
}
#weekly summary 
if(needWeekly==1){
sentence<-paste(colnames(buf.dataset)[2],"について",sep="")  
rankList<-list()
allSentence<-""
rankData<-buf.dataset
rankRange<-c(6,12,60,120,180,240,nrow(rankData))
rankRange<-head(rankRange,tail(rank(rankRange),1)-1)
if(inverse!=1){#非逆サイクルの場合
  rankData[,2]<-rankData[,2]*-1
}
for(rrr in 1:length(rankRange)){
  rankList[[rrr]]<-rank(tail(rankData[,2],rankRange[rrr]),ties.method="min")
}  
rankList[[rrr+1]]<-rank(tail(rankData[,2],nrow(rankData)),ties.method="min")
sentence<-paste(sentence,format(tail(rankData[,1],1),"%Y年%m月の結果は"),round(abs(tail(rankData[,2],1)),6),"です。",sep="")
sentence<-paste(sentence,"この結果は、",sep="")
rankSentence<-""
for(rrr in 1:(length(rankList)-1)){
  if(inverse!=1){
    rankSentence<-paste(rankSentence,"過去",rankRange[rrr],"ヶ月で",tail(rankList[[rrr]],1),"番目に高く、",sep="")
  }else{
    rankSentence<-paste(rankSentence,"過去",rankRange[rrr],"ヶ月で",tail(rankList[[rrr]],1),"番目に低く、",sep="")
  }  
}
if(inverse!=1){
  rankSentence<-paste(rankSentence,"対象期間",nrow(rankData),"ヶ月中、",tail(rankList[[length(rankList)]],1),"番目の高さです。",sep="")
}else{  
  rankSentence<-paste(rankSentence,"対象期間",nrow(rankData),"ヶ月中、",tail(rankList[[length(rankList)]],1),"番目の低さです。",sep="")
}
sentence<-paste(sentence,rankSentence,sep="")
maxData<-buf.dataset[which.max(buf.dataset[,2]),]  
minData<-buf.dataset[which.min(buf.dataset[,2]),]
maxResult<-subset(
  successiveCabinets[[1]],
  format(maxData[1,1],"%Y%m")>=format(successiveCabinets[[1]][,1],"%Y%m") & 
  format(maxData[1,1],"%Y%m")<=format(successiveCabinets[[1]][,2],"%Y%m")  
)  
minResult<-subset(
  successiveCabinets[[1]],
  format(minData[1,1],"%Y%m")>=format(successiveCabinets[[1]][,1],"%Y%m") & 
  format(minData[1,1],"%Y%m")<=format(successiveCabinets[[1]][,2],"%Y%m")  
)  
maxSentence<-paste("過去",nrow(rankData),"ヶ月の最大値は",as.vector(maxResult[,3]),"政権時の",maxData[1,2],sep="")  
minSentence<-paste("、最小値は",as.vector(minResult[,3]),"政権時の",minData[1,2],"です。\n\n\n\n",sep="")  
sentence<-paste(sentence,maxSentence,minSentence,sep="")  
cat(sentence,file=weeklyText,append=T) 
}
#weekly summary  
cat(paste("\n<div id=\"amccchart",ccc,"\" style=\"text-align:center\"><b>",colnames(buf.dataset)[2],"</b>\n",sep=""),file=htmlFile,append=T)
cat(paste("<br><select id=\"chartSelect",ccc,"\">\n",sep=""),file=htmlFile,append=T)
cat("<option value=\"\">Selecet a chart</option>\n",file=htmlFile,append=T)
for(zzz in 2:ncol(dataset)){  
  cat(paste("<option value=\"#amccchart",zzz,"\">",colnames(dataset)[zzz],"</option>\n",sep=""),file=htmlFile,append=T)
}
cat("</select></div>\n",file=htmlFile,append=T)
cat(paste("<a href=\"http://archive.am-consulting.co.jp/",png.file,
    "\"><img src=\"http://archive.am-consulting.co.jp/",png.file,
    "\" alt=\"",png.file,"\" width=\"100%\"></a>",sep=""),file=htmlFile,append=T)
print(g)
dev.off()
#CSV part
if(needCSV==1){
pathInput<-paste("C:/Users/",username,"/Desktop/pathToCSV/",sep="")
folder.path<-file.path(pathInput)
setwd(folder.path)
tmp<-read.csv(file=dir(folder.path),header=F,as.is=T,skip=0,na.strings=c("", "NA"))
dir.list<-paste("C:/Users/",username,tmp[1,2],sep="")
setwd(dir.list)
csvFile<-gsub("\\s","",paste(mainTitle,colnames(dataset[,c(1,ccc)])[2]))
csvFile<-paste(csvFile,".csv",sep="")
write.csv(tail(na.omit(dataset[,c(1,ccc)]),csvTail),csvFile,row.names=F,append=F,quote=F,fileEncoding="UTF-8")
#link to git part  
gitURL[[ccc]]<-paste("https://raw.githubusercontent.com/am-consulting/CSVDataAtGitHub/master/",csvFile,sep="")  
setwd(pathOutput)
cat(paste("\n\n<br><b>Link to csv file</b>( Original ",sep=""),file=htmlFile,append=T)
cat(paste(dataSource," )<br>\n",sep=""),file=htmlFile,append=T)
cat(paste("- <a href=\"",gitURL[[ccc]],"\">",mainTitle,colnames(dataset)[ccc],"</a><hr>\n",sep=""),file=htmlFile,append=T)
cat("\n\n\n",file=htmlFile,append=T)
#link to git part  
}  
#CSV part
}
#link to git part
if(needCSV==1){
cat(paste("\n\n<br><b>Link to csv file</b>( Original ",sep=""),file=onlyLink,append=T)
cat(paste(dataSource," )<br>\n",sep=""),file=onlyLink,append=T)
for(ccc in 2:ncol(dataset)){
cat(paste("- <a href=\"",gitURL[[ccc]],"\">",colnames(dataset)[ccc],"</a><br>\n",sep=""),file=onlyLink,append=T)
}
cat("\n\n\n",file=onlyLink,append=T)
}
#link to git part  
cat("<script>\n",file=htmlFile,append=T)
for(ggg in 2:ncol(dataset)){
cat(paste("document.getElementById(\"chartSelect",ggg,"\").onchange = function() {\n",sep=""),file=htmlFile,append=T)
cat("if (this.selectedIndex!==0) {\n",file=htmlFile,append=T)
cat("window.location.href = this.value;\n",file=htmlFile,append=T)
cat(paste("document.getElementById(\"chartSelect",ggg,"\").value = \"\";\n",sep=""),file=htmlFile,append=T)  
cat("}\n",file=htmlFile,append=T)
cat("};\n",file=htmlFile,append=T)
}
cat("</script>\n",file=htmlFile,append=T)
########################################## time series ##########################################
```

```{r}
#youtubegallery
cat("<style>.youtube_channel.ytc_wall_1-6 .ytc_video_container {padding: 5px;box-sizing: border-box;font-size: 15px;}</style>",file=htmlFile,append=T)
cat("<hr>",file=htmlFile,append=T)
cat("[youtube_channel class=ytc_wall_1-6 channel=UC56EoMsVlhV-OpB7Ua4KJ1Q resource=0 cache=300 num=6 random=0 ratio=3 responsive=0 width=140 display=thumbnail]",file=htmlFile,append=T)
#youtubegallery
```

```{r}
#amchartsPart
if(colnames(dataset)[1]=="Date"){
  dataset[,1]<-as.Date(dataset[,1])
}
setwd(pathOutput)
forAmcahrts<-na.omit(dataset)
forAmcahrts<-subset(forAmcahrts,as.Date("2013-01-01")<=forAmcahrts[,1])  
forAmcahrts<-data.frame(Date=forAmcahrts[,1],apply(forAmcahrts[,-1,drop=F],2,function(x) x/head(x,1)))
colnames(forAmcahrts)<-colnames(dataset)
head(forAmcahrts)
tail(forAmcahrts)
forAmcahrts<-head(forAmcahrts,5000000000000000000000)
cat(paste("<hr><div style=\"text-align:center\"><b>第二次安倍政権発足以降の各種指標 - 発足日(月)を1とする</b></div>\n",sep=""),file=htmlFile,append=T)
cat("<script src=\"http://archive.am-consulting.co.jp/amcharts315/amcharts.js\"></script>",file=htmlFile,append=T)
cat("<script src=\"http://archive.am-consulting.co.jp/amcharts315/serial.js\"></script>",file=htmlFile,append=T)
cat("<script src=\"http://archive.am-consulting.co.jp/amcharts315/themes/light.js\"></script>",file=htmlFile,append=T)
cat("<style>#chartdiv{width:100%;height:800px;font-size:11px;}</style>",file=htmlFile,append=T)    	
cat("<div id=\"chartdiv\"></div>\n",file=htmlFile,append=T)  
cat("<script>var chart = AmCharts.makeChart(\"chartdiv\", {\n",file=htmlFile,append=T)  
cat("\"type\": \"serial\",\n",file=htmlFile,append=T)  
cat("\"theme\": \"light\",\n",file=htmlFile,append=T)  
cat("\"marginRight\": 80,\n",file=htmlFile,append=T)  
cat("\"autoMarginOffset\": 20,\n",file=htmlFile,append=T)  
#cat("\"dataDateFormat\": \"YYYY-MM-DD\",\n",file=htmlFile,append=T)  
cat("\"valueAxes\": [{\n",file=htmlFile,append=T)  
cat("\"id\": \"v1\",\n",file=htmlFile,append=T)  
cat("\"axisAlpha\": 0,\n",file=htmlFile,append=T)  
cat("\"position\": \"left\"\n",file=htmlFile,append=T)  
cat("}],\n",file=htmlFile,append=T)  
cat("\"balloon\": {\n",file=htmlFile,append=T)
cat("\"maxWidth\":1000,\n",file=htmlFile,append=T)
cat("\"borderThickness\": 1,\n",file=htmlFile,append=T)  
cat("\"shadowAlpha\": 0\n",file=htmlFile,append=T)  
cat("},\n",file=htmlFile,append=T)  
cat("\"graphs\": [\n",file=htmlFile,append=T)
for(ccc in 2:ncol(forAmcahrts)){
cat("{\n",file=htmlFile,append=T) 
cat(paste("\"id\": \"g",ccc,"\",\n",sep=""),file=htmlFile,append=T) 
cat("\"bullet\": \"round\",\n",file=htmlFile,append=T) 
cat("\"bulletBorderAlpha\": 1,\n",file=htmlFile,append=T) 
cat("\"bulletColor\": \"#FFFFFF\",\n",file=htmlFile,append=T) 
cat("\"bulletSize\": 5,\n",file=htmlFile,append=T) 
cat("\"hideBulletsCount\": 50,\n",file=htmlFile,append=T) 
cat("\"lineThickness\": 2,\n",file=htmlFile,append=T) 
cat("\"title\": \"red line\",\n",file=htmlFile,append=T) 
cat("\"useLineColorForBulletBorder\": true,\n",file=htmlFile,append=T) 
cat(paste("\"valueField\": \"value",ccc,"\",\n",sep=""),file=htmlFile,append=T) 
cat(paste("\"balloonText\": \"<div style='margin:5px; font-size:19px;'><span style='font-size:13px;'>",colnames(forAmcahrts)[ccc],"</span>   [[value]]</div>\"\n",sep=""),file=htmlFile,append=T)
#<span style='font-size:13px;'>[[category]]</span>  
cat("}\n",file=htmlFile,append=T) 
if(ccc!=length(forAmcahrts)){cat(",\n",file=htmlFile,append=T)} 
}
cat("],\n",file=htmlFile,append=T)
cat("\"mouseWheelZoomEnabled\": true,\n",file=htmlFile,append=T)  
cat("\"chartScrollbar\": {\n",file=htmlFile,append=T)
cat("\"scrollbarHeight\":2,\n",file=htmlFile,append=T)
cat("\"offset\":-1,\n",file=htmlFile,append=T)
cat("\"backgroundAlpha\":0.1,\n",file=htmlFile,append=T)
cat("\"backgroundColor\":\"#888888\",\n",file=htmlFile,append=T)
cat("\"selectedBackgroundColor\":\"#67b7dc\",\n",file=htmlFile,append=T)
cat("\"selectedBackgroundAlpha\":1\n",file=htmlFile,append=T)
cat("},\n",file=htmlFile,append=T)
cat("\"chartCursor\": {\n",file=htmlFile,append=T)
cat("/*\n",file=htmlFile,append=T)  
cat("\"pan\": true,\n",file=htmlFile,append=T)
cat("\"valueLineEnabled\": true,\n",file=htmlFile,append=T)
cat("\"valueLineBalloonEnabled\": true,\n",file=htmlFile,append=T)
cat("\"cursorAlpha\":0,\n",file=htmlFile,append=T)
cat("\"valueLineAlpha\":0.2\n",file=htmlFile,append=T)
cat("*/\n",file=htmlFile,append=T)  
cat("},\n",file=htmlFile,append=T)
cat("\"categoryField\": \"date\",\n",file=htmlFile,append=T)
cat("\"categoryAxis\": {\n",file=htmlFile,append=T)
#cat("\"parseDates\": true,\n",file=htmlFile,append=T)
cat("\"labelRotation\": 90,\n",file=htmlFile,append=T)
cat("\"dashLength\": 1,\n",file=htmlFile,append=T)
cat("\"minorGridEnabled\": true\n",file=htmlFile,append=T)
cat("},\n",file=htmlFile,append=T)
cat("\"export\": {\n",file=htmlFile,append=T)
cat("\"enabled\": true\n",file=htmlFile,append=T)
cat("},\n",file=htmlFile,append=T)
cat("\"dataProvider\": [\n",file=htmlFile,append=T)
for(rrr in 1:nrow(forAmcahrts)){
  cat("{\n",file=htmlFile,append=T)
  cat(paste("\"date\": \"",format(forAmcahrts[rrr,1],"%Y年%m月"),"\",\n",sep=""),file=htmlFile,append=T)
  for(ccc in 2:ncol(forAmcahrts)){
    cat(paste("\"value",ccc,"\":",signif(forAmcahrts[rrr,ccc],digits=4),"\n",sep=""),file=htmlFile,append=T)
    if(ccc!=ncol(forAmcahrts)){cat(",\n",file=htmlFile,append=T)}
  }
  cat("}\n",file=htmlFile,append=T)
  if(rrr!=nrow(forAmcahrts)){cat(",\n",file=htmlFile,append=T)}
}
cat("]\n",file=htmlFile,append=T)
cat("});\n",file=htmlFile,append=T)
cat("chart.addListener(\"rendered\", zoomChart);\n",file=htmlFile,append=T)
cat("zoomChart();\n",file=htmlFile,append=T)
cat("function zoomChart() {\n",file=htmlFile,append=T)
cat("chart.zoomToIndexes(chart.dataProvider.length - ",nrow(forAmcahrts),", chart.dataProvider.length - 0);\n",file=htmlFile,append=T)
cat("}\n",file=htmlFile,append=T)
cat("</script>\n",file=htmlFile,append=T)
#amchartsPart
```

```{r}
##########################################  bar chart  ##########################################
ylimManual<-1
grandTitle<-"貸出先別貸出金 四半期調査 3月"
dataSource<-"\nData Source:日本銀行"
titleCol<-2 
orderType<-1 # 1:as is(including "Date") , 2-:colnumber
colorList<-c("blue","red") #改良余地あり
setwd(pathOutput)
if(colnames(dataset)[1]=="Date"){dataset[,1]<-as.Date(dataset[,1])}
buf.colnames<-colnames(dataset)
buf.dataset<-dataset
SD<-Sys.Date()
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste(addVer,".png",sep="")
png(file=png.file,width=1920,height=1080)
mainTitle<-buf.colnames[titleCol]
mainTitle<-gsub("source","\nData Source:",mainTitle)
mainTitle<-gsub("前年同月比","前年同月比(%)",mainTitle)
mainTitle<-gsub("割合","割合(%)",mainTitle)
mainTitle<-gsub("break","\n",mainTitle)
if(orderType!=1){
  rrr<-order(buf.dataset[,(orderType)],decreasing=FALSE)
  buf.dataset<-buf.dataset[rrr,]
  buf.dataset[,1]<-ordered(buf.dataset[,1],levels=buf.dataset[,1][length(buf.dataset[,1]):1])#Dateに適用するとNAに変換されるので注意
}  
if(ncol(buf.dataset)<=2){
  colnames(buf.dataset)<-c("xvalue","yvalue")
  buf.dataset[buf.dataset[,2]<0,3]<-"red"
  buf.dataset[buf.dataset[,2]>=0,3]<-"blue"
  colnames(buf.dataset)[3]<-"color"
  g<-ggplot()
  g<-g+geom_bar(data=buf.dataset,aes(x=xvalue,y=yvalue,fill=color),stat="identity",position="identity",alpha=0.2)
  g<-g+scale_fill_manual(values=colorList) 
  g<-g+geom_text(data=buf.dataset,aes(x=xvalue,y=yvalue,label=yvalue),hjust=0,size=10,family="Meiryo")
  g<-g+theme(legend.position="none")          
}else{
  melt.dataset<-melt(buf.dataset,id=colnames(buf.dataset)[1])  
  g<-ggplot(melt.dataset,aes(x=melt.dataset[,1],y=value,fill=variable))
  g<-g+geom_bar(stat="identity",position="dodge",alpha=0.3)  
  g<-g+theme(legend.text=element_text(colour="black",size=15,face="plain",family="Meiryo"))   
  g<-g+theme(legend.title=element_text(colour="white",size=0,face="bold"))   
  g<-g+scale_fill_manual(values=colorList) 
  g<-g+geom_text(data=melt.dataset,aes(label=value),hjust=-0.5,size=6,family="Meiryo",position=position_dodge(width=0.9))
}  
g<-g+theme(plot.title=element_text(size=30,family="Meiryo"))
g<-g+theme(axis.title.x=element_text(size=30)) 
g<-g+theme(axis.title.y=element_text(size=30)) 
g<-g+theme(axis.text.x=element_text(size=25,angle=0,hjust=1,vjust=0.5)) 
g<-g+theme(axis.text.y=element_text(size=24,color="black",face="bold")) 
g<-g+ggtitle(paste(grandTitle,":",mainTitle,dataSource))
if(colnames(dataset)[1]=="Date" & regexpr("\\.月次",buf.colnames[2])!=-1){  
  g<-g+scale_x_date(labels=date_format("%Y-%m"))  
} 
if(ylimManual==1){
  g<-g+scale_y_continuous(labels=comma,limits=c(0,150000))
}else{
  g<-g+scale_y_continuous(labels=comma)
}  
g<-g+xlab("")
g<-g+ylab("")
g<-g+coord_flip()
print(g)
dev.off()
##########################################  bar chart  ##########################################
```

```{r}
##########################################  Japan Map  ##########################################
color.set<-c("#f8f8fc","#f1f1f8","#e2e2f1","#c7c7e2","#aaaad5","#8d8dc7","#7272b8","#5555aa","#47478d","#383872","#2b2b55","#1d1d38")
color.set<-c("#f8f8fc","#e2e2f1","#aaaad5","#7272b8","#47478d","#2b2b55")
lon.center<-NULL
lat.center<-NULL  
plotValue<-NULL
#####The following source codes and Japanese comments are the copyright of http://aoki2.si.gunma-u.ac.jp/.
# 塗り分け地図を描く
map <- function(code.list,                  # 描画する都道府県コード
density=NULL,                               # ハッチングの 1 インチあたりの線密度
color=NULL)                                 # 塗り分けに使用する色
{
  map0 <- function(data, dens, color)       # 描画関数
  {
    ### The following codes are added by AMCC.
      setwd(pathOutput)                         
      SD<-Sys.Date()
      ST<-Sys.time()  
      addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
      creationDate<-paste("作成日:",year(SD),"-",month(SD),"-",day(SD),sep="")  
      png.file<-paste(addVer,".png",sep="")      
      png(file=png.file,width=1920,height=1080) 
      par(mar=c(6,0,12,0),ps=40)
    ### The above codes are added by AMCC.
    continue <- apply(data, 1, any)         # 経度と緯度が共に 0 が描画の区切り
    plot(lon, lat, type = "n", axes=FALSE,  # 大枠を決める
    xlab="", ylab="", bty="n", asp=1,
    main=paste(mainTitle),cex.main="1.5",cex.sub="1.0",family="Meiryo",sub="Choropleth map is made by map.R(http://aoki2.si.gunma-u.ac.jp/)") # This code is added by AMCC.
    start <- 1
    k <- 0
    for (i in 2:nrow(data)) {
      if (continue[i] == FALSE) {           # 区切れ目
        k <- k+1                            # 何番目の描画か
        if (i-start == 4) {                 # 沖縄を描くときの区画線
          lines(data[start:(i-1),])
        }
        else {
          ### The following codes are added by AMCC.
          lon.center<-c(lon.center,(max(data[start:(i-1),1])+min(data[start:(i-1),1]))/2)
          lat.center<-c(lat.center,(max(data[start:(i-1),2])+min(data[start:(i-1),2]))/2)
          plotValue<-c(plotValue,tmp.1[k])
          if(fillType==1){
          ### The above codes are added by AMCC.
            polygon(data[start:(i-1),], density=dens[k], col=color[k], border="black")
          ### The following codes are added by AMCC.
          }else{
            polygon(data[start:(i-1),], density=dens[k],  border="black")
            draw.circle(lon.center,lat.center,(tmp.1[k]/min(tmp.1))*magnify,col=rgb(255,0,0,160,maxColorValue=255),border=rgb(255,0,0,maxColorValue=255))
          }  
          ### The above codes are added by AMCC.
        }
        start <- i+1
      }
    }
    if(textPlot==1){
      text(lon.center,lat.center,round(plotValue,2),cex=textSize,col="black",font=1) # This code is added by AMCC.         
    }
    ### The following codes are added by AMCC. Reference http://ds0.cc.yamaguchi-u.ac.jp/~fukuyo/r-map.html
      if(fillType==1){
      heightPoly<-30
      basePoly01<-100
      basePoly02<-basePoly01+heightPoly
      widthPoly<-40
      for (ppp in 1:(length(color.set))){
        #時計回りに長方形×1
        xPolygon<-c(0,0,widthPoly,widthPoly,0)
        yPolygon<-c(basePoly01+heightPoly*ppp,basePoly02+heightPoly*ppp,basePoly02+heightPoly*ppp,basePoly01+heightPoly*ppp,basePoly01+heightPoly*ppp)
        polygon(xPolygon, yPolygon, col=color.set[ppp],border="black")
        #時計回りに長方形×1
        if(ppp!=length(color.set)){
          text(widthPoly+5,basePoly02+heightPoly*ppp,labels=format(t[ppp],big.mark=",",scientific=F),adj=0)
        }  
      }
      }  
      dev.off()
    ### The above codes are added by AMCC. Reference http://ds0.cc.yamaguchi-u.ac.jp/~fukuyo/r-map.html
  }
  # 関数本体
  for (i in seq(along=code.list)) {               # 指定した全ての都道府県について
    if (code.list[i] %in% c(15, 28, 47)) {        # 新潟県，兵庫県，沖縄県は描画パーツが 2 つ
      code.list <- c(code.list, -code.list[i])    # コードリストの追加（目印とするために負の数で）
      density <- c(density, density[i])           # 線密度と
      color <- c(color, color[i])                 # 色も追加する
    }
  }
  code.list[code.list == -15] <- 48               # 追加のコードリストに直す
  code.list[code.list == -28] <- 49
  code.list[code.list == -47] <- 50
  lon <- lat <- NULL
  setwd(pathJmap)# This code is added by AMCC.
  for (i in code.list) {                                     # 指定した全ての都道府県について
    fn <- sprintf("jpn/%02i", i)                             # データファイル名を得る
    gwm <- matrix(scan(fn, quiet=TRUE), ncol=2, byrow=TRUE)  # データを読む
    lon <- c(lon, gwm[,1], 0)                                # 経度を蓄積
    lat <- c(lat, gwm[,2], 0)                                # 緯度を蓄積
  }
  mlon <- min(lon[lon != 0])                                    # 経度の最小値
  mlat <- max(lat[lat != 0])                                    # 緯度の最大値
  lon <- ifelse(lon == 0, 0, lon-mlon+1)                        # 経度の調整
  lat <- ifelse(lat == 0, 0, mlat-lat+1)                        # 緯度の調整
  map0(cbind(as.integer(lon), as.integer(lat)), density, color) # 描画関数を呼ぶ
}
# データにより塗り分け地図を描く
color.map3 <- function(x,  # 長さ 47 の統計データベクトル
t,                         # データを区分する値
color.set)                 # 各区分を塗る色
{
  if (length(t)+1 != length(color.set)) {
    stop("t の長さは color.set の長さより 1 だけ小さくなければならない")
  }
  map(1:47, color=color.set[findInterval(x, t)+1])
}
#########The above source codes and Japanese comments are the copyright of http://aoki2.si.gunma-u.ac.jp/.  
```

```{r}
#コロプレスマップの描画順序(k)とオリジナルデータの都道府県順序が一致しているか十分に気をつけること
textSize<-0.6
nSplit<-6
textPlot<-1
fillType<-1
magnify<-1
roundType<-2
Nsmall<-2
classStyle<-c("sd", "equal", "quantile", "kmeans", "hclust", "fisher")
classStyleJ<-c("標準偏差", "等間隔", "等量", "非階層クラスタリング", "階層クラスタリング", "Fisherの最適化")
classStyle<-c("equal", "quantile", "fisher")
classStyleJ<-c("等間隔", "等量", "Fisherの最適化")
tmp.0<-dataset 
for(iii in 2:length(tmp.0)){
  q<-vector()
  t<-vector()
  q<-NULL
  t<-NULL
  mid<-3 #奇数
  tmp.1<-dataset[,iii] 
  if(is.na(sum(tmp.1))==F){
    rrr<-order(tmp.0[,iii])
    tmp.0<-tmp.0[rrr,]
    rownames(tmp.0)<-c(1:nrow(tmp.0))
    tmp.0[,1]<-ordered(tmp.0[,1],levels=tmp.0[,1][1:length(tmp.0[,1])])
    mainTitle<-colnames(tmp.0)[iii]
    mainTitle<-gsub("source","\nData Source:",mainTitle)
    mainTitle<-gsub("前年同月比\\.","前年同月比(%)\n",mainTitle)
    mainTitle<-gsub("割合","割合(%)",mainTitle)
    mainTitle<-gsub("パーセント","%",mainTitle)
    mainTitle<-gsub("break","\n",mainTitle)
##################分類・凡例パート 参考資料 古谷知之.『Rによる空間データの統計分析』.朝倉書店.2011.pp168 
# fixed, sd, equal, pretty, quantile, kmeans, hclust, bclust, fisher, jenks  
# Blues BuGn BuPu GnBu Greens Greys Oranges OrRd PuBu PuBuGn PuRd Purples RdPu Reds YlGn YlGnBu YlOrBr YlOrRd    
# use nclass{grDevices} or n
# http://www.inside-r.org/packages/cran/classInt/docs/classIntervals    
    for(zzz in 1:length(classStyle)){
      t<-(classIntervals(tmp.0[,iii],style=classStyle[zzz],n=nSplit))$brks
      switch(roundType,
      t<-round(t,-(floor(log10(t))-1)), # t=10^log10(t)の場合の処理を挟むこと
      t<-format(t,digits=2) #改良余地あり
      )
      t<-as.numeric(t)
      t<-t[-1]
      t<-t[-length(t)]    
      color.set<-brewer.pal(length(t)+1,"Blues")
      tmp.mainTitle<-mainTitle
      mainTitle<-paste(mainTitle,", 分類方法:",classStyleJ[zzz])
      color.map3(tmp.1,t,color.set)
      mainTitle<-tmp.mainTitle
    }  
##################分類・凡例パート    
  }
}  
##########################################  Japan Map  ##########################################
```

```{r}
##########################################  World Map  ##########################################
##########################################  common part  ########################################
mapType<-2 # 1:shape data , 2:library(rworldmap)
classType<-2 # 1:auto break , 2:manual break
brew<-2 # 1:brewer , 2:auto(colorful)
mainTitle<-colnames(dataset)[2]
mainTitle<-gsub("source","\nData Source:",mainTitle)
mainTitle<-gsub("前年同月比\\.","前年同月比(%)\n",mainTitle)
mainTitle<-gsub("割合","割合(%)",mainTitle)
mainTitle<-gsub("break","\n",mainTitle)
SD<-Sys.Date()
creationDate<-paste("作成日:",year(SD),"-",month(SD),"-",day(SD),sep="")  
merge.by<-colnames(countryDataset)[1]
dataset[,2]<-as.numeric(dataset[,2])
buf.dataColname<-colnames(dataset)[2]
mergeDataset<-merge(countryDataset,dataset,by=merge.by)
colnames(mergeDataset)[3]<-"value"
if(mapType==1){
  valueForNA<-min(na.omit(mergeDataset[,3]))-10 ########## 要改良
  if(classType==1){
    n<-8  
    classInt<-NULL
    catMethod<-NULL
    classInt<-classIntervals(na.omit(mergeDataset[["value"]]),n=n,style="jenks")
    catMethod<-c(valueForNA,classInt[["brks"]])
    catMethod<-catMethod[-length(catMethod)]
    mergeDataset[,3][is.na(mergeDataset[,3])]<-valueForNA
  }else{  
    catMethod<-NULL
    catMethod<-c(valueForNA , min(na.omit(mergeDataset[,3])) , 2 , 4 , 6 , 8 , 10 , 15 , 20)
    n<-length(catMethod)
    mergeDataset[,3][is.na(mergeDataset[,3])]<-valueForNA
  }
  colourPalette<-c("black",brewer.pal(n-0,'RdPu'))
}else{
  n<-9  
  classInt<-NULL
  catMethod<-NULL
  classInt<-classIntervals(mergeDataset[["value"]],n=n,style="jenks") #,style="fixed",fixedBreaks=fiedBr ) #caution max(n)=9 
  colourPalette<-brewer.pal(n,"RdPu")
  catMethod<-classInt[["brks"]]
}  
##########################################  common part  ########################################
#######################  Read a ShapeData and create a merged data frame ########################
if(mapType==1){
setwd(pathWmap)
file.name<-dir(pathWmap,pattern=".shp")
map.obj<-readShapeSpatial(file.name)
names(map.obj)
plot(map.obj)
map.df<-fortify(map.obj,region="iso_a3")
colnames(map.df)[7]<-merge.by
mapData<-merge(map.df,mergeDataset,by=merge.by)
mapData<-mapData[order(mapData$order),]
tmp.0<-findInterval(mapData$value,catMethod) #findIntervalはA1<= x1 < A2,classIntはA1< x1 <= A2のため注意すること
mapData$classfied<-catMethod[tmp.0]
setwd(pathOutput)                         
SD<-Sys.Date()
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste(addVer,".png",sep="")      
png(file=png.file,width=1400,height=900) 
par(mar=c(0,0,12,0),ps=40)
q<-ggplot(mapData)
q<-q+aes(long,lat,group=group)+geom_polygon(aes(fill=factor(classfied)))+geom_path(color="white")+coord_equal()
if(brew==1){
  q<-q+scale_fill_manual(name="",values=colourPalette,guide="legend",labels=c("NA",paste(catMethod[-1],"～")))
}else{
  q<-q+scale_fill_discrete(name="",labels=c("NA",paste(catMethod[-1],"～")))
}  
q<-q+xlab("")+ylab("")
q<-q+ggtitle(paste(mainTitle,"\n",creationDate))
q<-q+theme(axis.text=element_text(size=30),axis.title=element_text(colour="white",size=1,face="bold"))   
q<-q+theme(title=element_text(size=40,face="bold"),legend.position="bottom")   
q<-q+theme(legend.text=element_text(colour="black",size=40,face="bold"))   
q<-q+theme(legend.title=element_text(colour="white",size=40,face="bold"))   
print(q)
dev.off()
################################# 確認用ループ。出力との直接の関係は無い ########################
for(zzz in 1:(length(catMethod))){
  if(zzz==1){  
    buf<-subset(mapData,catMethod[zzz]<=mapData$value & mapData$value<catMethod[zzz+1]) 
    cat(catMethod[zzz],"-",catMethod[zzz+1],"\n")  
  }else if(zzz==2){  
    buf<-subset(mapData,catMethod[zzz]<=mapData$value & mapData$value<=catMethod[zzz+1]) 
    cat(catMethod[zzz],"-",catMethod[zzz+1],"\n")  
  }else if(zzz!=(length(catMethod))){  
    buf<-subset(mapData,catMethod[zzz]<mapData$value & mapData$value<=catMethod[zzz+1]) 
    cat(catMethod[zzz],"-",catMethod[zzz+1],"\n")  
  }else{
    buf<-subset(mapData,catMethod[zzz]<mapData$value) 
    cat(catMethod[zzz],"-","\n")  
  }  
  print(unique(buf$cName))
  print(length(unique(buf$cName)))
  cat("\n\n")  
}  
for(zzz in 1:(length(unique(mapData$classfied)))){
  buf<-subset(mapData,catMethod[zzz]==mapData$classfied) 
  print(unique(buf$cName))
  print(length(unique(buf$cName)))
  cat("\n\n")  
}  
################################# 確認用ループ。出力との直接の関係は無い ########################
}  
#######################  Read a ShapeData and create a merged data frame ########################
#######################  Create a merged data and a map by 'rworldmap' ########################
if(mapType==2){
mapData<-joinCountryData2Map(mergeDataset,joinCode="ISO3",nameJoinColumn=merge.by)  
SD<-Sys.Date()
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste(addVer,".png",sep="")      
png(file=png.file,width=1500,height=1000) 
par(mai=c(0,0,1,0),xaxs="i",yaxs="i",ps=40)
buf.mapData<-mapCountryData(
  mapData,
  nameColumnToPlot="value",
  addLegend=FALSE,
  catMethod=catMethod,
  colourPalette=colourPalette,
  missingCountryCol="white",
  borderCol="black",
  oceanCol="lightblue",
  mapTitle=paste("\n\n",mainTitle,"\n",creationDate)
  )
do.call(
  addMapLegend,
  c(
    buf.mapData,
    legendLabels="all",
    legendIntervals="data",
    legendWidth=1,
    legendMar=2
  )
  )
dev.off()  
}  
###################################### make a chart #############################################
##########################################  World Map  ##########################################
```

```{r}
##########################################  World Map  ##########################################
countryName<-c(
"AFG","Afghanistan",
"ALB","Albania",
"DZA","Algeria",
"AGO","Angola",
"ATG","Antigua and Barbuda",
"ARG","Argentina",
"ARM","Armenia",
"AUS","Australia",
"AUT","Austria",
"AZE","Azerbaijan",
"BHS","The Bahamas",
"BHR","Bahrain",
"BGD","Bangladesh",
"BRB","Barbados",
"BLR","Belarus",
"BEL","Belgium",
"BLZ","Belize",
"BEN","Benin",
"BTN","Bhutan",
"BOL","Bolivia",
"BIH","Bosnia and Herzegovina",
"BWA","Botswana",
"BRA","Brazil",
"BRN","Brunei Darussalam",
"BGR","Bulgaria",
"BFA","Burkina Faso",
"BDI","Burundi",
"CPV","Cabo Verde",
"KHM","Cambodia",
"CMR","Cameroon",
"CAN","Canada",
"CAF","Central African Republic",
"TCD","Chad",
"CHL","Chile",
"CHN","China",
"COL","Colombia",
"COM","Comoros",
"COD","Democratic Republic of the Congo",
"COG","Republic of Congo",
"CRI","Costa Rica",
"CIV","Republic of Cote dIvoire",
"HRV","Croatia",
"CYP","Cyprus",
"CZE","Czech Republic",
"DNK","Denmark",
"DJI","Djibouti",
"DMA","Dominica",
"DOM","Dominican Republic",
"ECU","Ecuador",
"EGY","Egypt",
"SLV","El Salvador",
"GNQ","Equatorial Guinea",
"ERI","Eritrea",
"EST","Estonia",
"ETH","Ethiopia",
"FJI","Fiji",
"FIN","Finland",
"FRA","France",
"GAB","Gabon",
"GMB","The Gambia",
"GEO","Georgia",
"DEU","Germany",
"GHA","Ghana",
"GRC","Greece",
"GRD","Grenada",
"GTM","Guatemala",
"GIN","Guinea",
"GNB","Guinea-Bissau",
"GUY","Guyana",
"HTI","Haiti",
"HND","Honduras",
"HKG","Hong Kong SAR",
"HUN","Hungary",
"ISL","Iceland",
"IND","India",
"IDN","Indonesia",
"IRN","Islamic Republic of Iran",
"IRQ","Iraq",
"IRL","Ireland",
"ISR","Israel",
"ITA","Italy",
"JAM","Jamaica",
"JPN","Japan",
"JOR","Jordan",
"KAZ","Kazakhstan",
"KEN","Kenya",
"KIR","Kiribati",
"KOR","Korea",
"UVK","Kosovo",
"KWT","Kuwait",
"KGZ","Kyrgyz Republic",
"LAO","Lao P.D.R.",
"LVA","Latvia",
"LBN","Lebanon",
"LSO","Lesotho",
"LBR","Liberia",
"LBY","Libya",
"LTU","Lithuania",
"LUX","Luxembourg",
"MKD","FYR Macedonia",
"MDG","Madagascar",
"MWI","Malawi",
"MYS","Malaysia",
"MDV","Maldives",
"MLI","Mali",
"MLT","Malta",
"MHL","Marshall Islands",
"MRT","Mauritania",
"MUS","Mauritius",
"MEX","Mexico",
"FSM","Micronesia",
"MDA","Moldova",
"MNG","Mongolia",
"MNE","Montenegro",
"MAR","Morocco",
"MOZ","Mozambique",
"MMR","Myanmar",
"NAM","Namibia",
"NPL","Nepal",
"NLD","Netherlands",
"NZL","New Zealand",
"NIC","Nicaragua",
"NER","Niger",
"NGA","Nigeria",
"NOR","Norway",
"OMN","Oman",
"PAK","Pakistan",
"PLW","Palau",
"PAN","Panama",
"PNG","Papua New Guinea",
"PRY","Paraguay",
"PER","Peru",
"PHL","Philippines",
"POL","Poland",
"PRT","Portugal",
"QAT","Qatar",
"ROU","Romania",
"RUS","Russia",
"RWA","Rwanda",
"WSM","Samoa",
"SMR","San Marino",
"STP","Sao Tome and Pr incipe",
"SAU","Saudi Arabia",
"SEN","Senegal",
"SRB","Serbia",
"SYC","Seychelles",
"SLE","Sierra Leone",
"SGP","Singapore",
"SVK","Slovak Republic",
"SVN","Slovenia",
"SLB","Solomon Islands",
"ZAF","South Africa",
"SSD","South Sudan",
"ESP","Spain",
"LKA","Sri Lanka",
"KNA","St.Kitts and Nevis",
"LCA","St.Lucia",
"VCT","St.Vincent and the Grenadines",
"SDN","Sudan",
"SUR","Suriname",
"SWZ","Swaziland",
"SWE","Sweden",
"CHE","Switzerland",
"SYR","Syria",
"TWN","Taiwan Province of China",
"TJK","Tajikistan",
"TZA","Tanzania",
"THA","Thailand",
"TLS","Timor-Leste",
"TGO","Togo",
"TON","Tonga",
"TTO","Trinidad and Tobago",
"TUN","Tunisia",
"TUR","Turkey",
"TKM","Turkmenistan",
"TUV","Tuvalu",
"UGA","Uganda",
"UKR","Ukraine",
"ARE","United Arab Emirates",
"GBR","United Kingdom",
"USA","United States",
"URY","Uruguay",
"UZB","Uzbekistan",
"VUT","Vanuatu",
"VEN","Venezuela",
"VNM","Vietnam",
"YEM","Yemen",
"ZMB","Zambia",
"ZWE","Zimbabwe"
)
ISO<-countryName[seq(1,length(countryName),by=2)]
cName<-countryName[seq(2,length(countryName),by=2)]
countryDataset<-data.frame(ISO,cName)
##########################################  World Map  ##########################################
```

```{r}
########################################## pyramid plot #########################################
plotType<-1
setwd(pathOutput) 
SD<-Sys.Date()
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste(addVer,".png",sep="")      
png(file=png.file,width=1400,height=900) 
par(ps=30)
mainTitle<-paste("法人企業統計調査.金融業、保険業以外の業種(原数値)\nソフトウェアを除く設備投資(当期末新設固定資産).全規模.兆円","\n",creationDate)
########################################## pyramid.plot() #######################################
if(plotType==1){
xlimit<-12 #改良余地在り
xlabBy<-1  #改良余地在り　
displayN<-50  
lx<-tail(as.numeric(dataset[,2]),displayN)/10^0
rx<-tail(as.numeric(dataset[,3]),displayN)/10^0
labelsTitle<-tail(as.character(dataset[,1]),displayN)
labelsText<-c(colnames(dataset)[2],colnames(dataset)[1],colnames(dataset)[3])
unitText<-""
par(
  mar=pyramid.plot(
    lx,
    rx,
    labels=labelsTitle,
    top.labels=labelsText,
    unit=unitText,
    main=mainTitle,
    lxcol="#e27272",
    rxcol="#72aae2",
    space=0.3,
    ppmar=c(5,5,14,5),
    labelcex=0.8,
    xlim=c(xlimit,xlimit),
    laxlab=seq(from = 0, to = xlimit, by = xlabBy), #改良余地在り
    raxlab=seq(from = 0, to = xlimit, by = xlabBy), #改良余地在り
    gap=2 #改良余地在り
  )
)
}
########################################## pyramid.plot() #######################################
########################################## pyramidLikert() ######################################
if(plotType==2){
panelWidth<-0.4
main.cex<-1.2
xlab.cex<-1.5
xlabTitle<-"百万円" #改良余地在り
ylabTitle<-"期"     #改良余地在り
buf.plot<-plot(
  as.likert(dataset[,-1]),
  scales=list(
    y=list(
      limits=c(0,nrow(dataset)+1),
      at=seq(1,nrow(dataset),1),
      labels=rev(dataset[,1]),
      cex=1.2,
      tck=0.5
    ),
    x=list(
      cex=2,
      tck=0.5
    )
  ),
  main=list(
    mainTitle,
    cex=main.cex
  ),
  xlab=list(
    xlabTitle,
    cex=xlab.cex
  ),  
  ylab=list(
    ylabTitle
  )
)
as.pyramidLikert(
  buf.plot,
  px=list(
    L=c(0, panelWidth),
    R=c(1-panelWidth, 1),
    M=c(panelWidth, 1-panelWidth)
  )
)
}
########################################## pyramidLikert ########################################
dev.off()
########################################## pyramid plot #########################################
```

