```{r}
library(XML)
library(Nippon)
library(lubridate)
username<-Sys.info()['user']
pathOutput<-paste("C:/Users/",username,"/Desktop/R_Data_Write/",sep="")
setwd(pathOutput)
SD<-Sys.Date()
sourceURL<-"http://www.jma.go.jp/jp/quake/quake_local_index.html"
windowsFonts(Meiryo=windowsFont("Meiryo"))
tmp<-readHTMLTable(doc=sourceURL,header=T,trim=T,stringsAsFactors=F,as.data.frame=T,which=4)
getTime<-Sys.time()
colnames(tmp)<-iconv(colnames(tmp),"utf-8")
buf<-data.frame()
for(rrr in 1:nrow(tmp)){
  for(ccc in 1:ncol(tmp)){  
    buf[rrr,ccc]<-zen2han(tmp[rrr,ccc])
  }
}
year<-as.numeric(substring(buf[,1],3,4))-28+2016
month<-as.numeric(substring(buf[,1],6,7))
day<-as.numeric(substring(buf[,1],9,10))
hour<-as.numeric(substring(buf[,1],12,13))
minute<-as.numeric(substring(buf[,1],15,16))
announcement<-as.POSIXct(paste(year,"-",month,"-",day," ",hour,":",minute,sep=""))
#ソースデータの表記は分まで(秒表記はない)
day<-as.numeric(substring(buf[,2],1,2))
hour<-as.numeric(substring(buf[,2],4,5))
minute<-as.numeric(substring(buf[,2],7,8))
detection<-as.POSIXct(paste(year,"-",month,"-",day," ",hour,":",minute,sep=""))
difftime<-announcement-detection
difftime
if(all((difftime)>=0)==TRUE){
#極端な例として、発表が2017年01月01日00時02分、検知が2016年01月01日00時01分の場合、本判定では検知年、検知月に誤りが生じる。
#検知と発表が年を跨いた場合、どの様にWebサイトで表記されているのか注意。過去の情報入手できず。
  No<-c(1:length(announcement))
  location<-buf[,3]
  magnitude<-gsub("M","",buf[,4])
  intensity<-gsub("震度","",buf[,5])
  diff(detection)
  gap<-abs(diff(detection)/60)
  dataset<-data.frame(No,announcement,detection,as.numeric(difftime),day,hour,location,c(as.numeric(gap),-9999),magnitude,intensity)
}
colnames(dataset)<-c("No.","情報発表日時","検知日時","検知から発表まで(分)","検知日時(日)","検知日時(時)","震央地名","直近地震からの時間差(分)","マグニチュード","最大震度")
#plot part
ST<-Sys.time()  
addVer<-gsub("\\.","",paste(year(SD),month(SD),day(SD),hour(ST),minute(ST),second(ST),sep=""))
png.file<-paste("amcc_",addVer,".png",sep="")
png(file=png.file,width=950,height=800)
par(mfrow=c(1,2),family="Meiryo",ps=18)
maintext<-"地震発生時刻(24時間表記)"
xtext<-"検知時刻･1時間刻み･0時から24時"
h<-hist(dataset[,6],breaks=seq(0,24,by=1),plot=F)
h$density<-round(h$counts/sum(h$counts)*100,1)
plot(h,freq=F,xlab=xtext,ylab="%",main=maintext,family="Meiryo",col="#6495ED")
h$density
maintext<-"地震発生間隔(60分刻み)"
xtext<-"地震発生間隔･60分刻み"
h<-hist(as.numeric(gap),breaks=seq(0,ceiling(max(as.numeric(gap))/60))*60,plot=F)
h$density<-round(h$counts/sum(h$counts)*100,1)
plot(h,freq=F,xlab=xtext,ylab="%",main=maintext,col="#6495ED")
h$density
dev.off()
write.csv(dataset,"earthquake1week.csv",quote=F,row.names=F)
```